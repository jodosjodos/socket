"use strict";
Object.defineProperty(exports, "__esModule", {
    value: true
});
Object.defineProperty(exports, "default", {
    enumerable: true,
    get: function() {
        return HistoryClient;
    }
});
const _metaApiclient = /*#__PURE__*/ _interop_require_default(require("../metaApi.client"));
const _transactionListenerManager = /*#__PURE__*/ _interop_require_default(require("./streaming/transactionListenerManager"));
function _interop_require_default(obj) {
    return obj && obj.__esModule ? obj : {
        default: obj
    };
}
let HistoryClient = class HistoryClient extends _metaApiclient.default {
    /**
   * CopyFactory provider or subscriber user
   * @typedef {Object} CopyFactorySubscriberOrProviderUser
   * @property {String} id profile id
   * @property {String} name user name
   * @property {Array<CopyFactoryStrategyIdAndName>} strategies array of strategy IDs provided by provider
   * or subscribed to by subscriber
   */ /**
   * CopyFactory strategy id and name
   * @typedef {Object} CopyFactoryStrategyIdAndName
   * @property {String} id unique strategy id
   * @property {String} name human-readable strategy name
   */ /**
   * CopyFactory transaction
   * @typedef {Object} CopyFactoryTransaction
   * @property {String} id transaction id
   * @property {String} type transaction type (one of DEAL_TYPE_BUY, DEAL_TYPE_SELL, DEAL_TYPE_BALANCE,
   * DEAL_TYPE_CREDIT, DEAL_TYPE_CHARGE, DEAL_TYPE_CORRECTION, DEAL_TYPE_BONUS, DEAL_TYPE_COMMISSION,
   * DEAL_TYPE_COMMISSION_DAILY, DEAL_TYPE_COMMISSION_MONTHLY, DEAL_TYPE_COMMISSION_AGENT_DAILY,
   * DEAL_TYPE_COMMISSION_AGENT_MONTHLY, DEAL_TYPE_INTEREST, DEAL_TYPE_BUY_CANCELED, DEAL_TYPE_SELL_CANCELED,
   * DEAL_DIVIDEND, DEAL_DIVIDEND_FRANKED, DEAL_TAX). See
   * https://www.mql5.com/en/docs/constants/tradingconstants/dealproperties#enum_deal_type
   * @property {Date} time transaction time
   * @property {String} subscriberId CopyFactory subscriber id
   * @property {String} [symbol] symbol traded
   * @property {CopyFactorySubscriberOrProviderUser} subscriberUser strategy subscriber
   * @property {Boolean} demo demo account flag
   * @property {CopyFactorySubscriberOrProviderUser} providerUser strategy provider
   * @property {CopyFactoryStrategyIdAndName} strategy strategy
   * @property {String} [positionId] source position id
   * @property {String} [slavePositionId] slave position id
   * @property {Number} improvement high-water mark strategy balance improvement
   * @property {Number} providerCommission provider commission
   * @property {Number} platformCommission platform commission
   * @property {Number} [incomingProviderCommission] commission paid by provider to underlying providers
   * @property {Number} [incomingPlatformCommission] platform commission paid by provider to underlying providers
   * @property {Number} [quantity] trade volume
   * @property {Number} [lotPrice] trade lot price
   * @property {Number} [tickPrice] trade tick price
   * @property {Number} [amount] trade amount
   * @property {Number} [commission] trade commission
   * @property {Number} swap trade swap
   * @property {Number} profit trade profit
   * @property {CopyFactoryTransactionMetrics} [metrics] trade copying metrics such as slippage and latencies. Measured
   * selectively for copied trades
   */ /**
   * Trade copying metrics such as slippage and latencies
   * @typedef {Object} CopyFactoryTransactionMetrics
   * @property {Number} [tradeCopyingLatency] trade copying latency, measured in milliseconds based on transaction time
   * provided by broker
   * @property {Number} [tradeCopyingSlippageInBasisPoints] trade copying slippage, measured in basis points (0.01
   * percent) based on transaction price provided by broker
   * @property {Number} [tradeCopyingSlippageInAccountCurrency] trade copying slippage, measured in account currency
   * based on transaction price provided by broker
   * @property {Number} [mtAndBrokerSignalLatency] trade signal latency introduced by broker and MT platform, measured
   * in milliseconds
   * @property {Number} [tradeAlgorithmLatency] trade algorithm latency introduced by CopyFactory servers, measured in
   * milliseconds
   * @property {Number} [mtAndBrokerTradeLatency] trade latency for a copied trade introduced by broker and MT platform,
   * measured in milliseconds
   */ /**
   * Returns list of transactions on the strategies the current user provides to other users
   * https://metaapi.cloud/docs/copyfactory/restApi/api/history/getProvidedTransactions/
   * @param {Date} from time to load transactions from
   * @param {Date} till time to load transactions till
   * @param {Array<string>} [strategyIds] list of strategy ids to filter transactions by
   * @param {Array<string>} [subscriberIds] the list of CopyFactory subscriber account ids to filter by
   * @param {number} [offset] pagination offset. Default value is 0
   * @param {number} [limit] pagination limit. Default value is 1000
   * @return {Promise<Array<CopyFactoryTransaction>>} promise resolving with transactions found
   */ async getProvidedTransactions(from, till, strategyIds, subscriberIds, offset, limit) {
        if (this._isNotJwtToken()) {
            return this._handleNoAccessError("getProvidedTransactions");
        }
        let params = {
            from,
            till
        };
        if (strategyIds) {
            params.strategyId = strategyIds;
        }
        if (subscriberIds) {
            params.subscriberId = subscriberIds;
        }
        if (offset !== undefined) {
            params.offset = offset;
        }
        if (limit) {
            params.limit = limit;
        }
        const opts = {
            url: "/users/current/provided-transactions",
            method: "GET",
            headers: {
                "auth-token": this._token
            },
            params,
            json: true
        };
        let transactions = await this._domainClient.requestCopyFactory(opts, true);
        transactions.forEach((t)=>t.time = new Date(t.time));
        return transactions;
    }
    /**
   * Returns list of trades on the strategies the current user subscribed to
   * https://metaapi.cloud/docs/copyfactory/restApi/api/history/getSubscriptionTransactions/
   * @param {Date} from time to load transactions from
   * @param {Date} till time to load transactions till
   * @param {Array<String>} [strategyIds] list of strategy ids to filter transactions by
   * @param {Array<string>} [subscriberIds] the list of CopyFactory subscriber account ids to filter by
   * @param {Number} offset pagination offset. Default value is 0
   * @param {Number} limit pagination limit. Default value is 1000
   * @return {Promise<Array<CopyFactoryTransaction>>} promise resolving with transactions found
   */ async getSubscriptionTransactions(from, till, strategyIds, subscriberIds, offset, limit) {
        if (this._isNotJwtToken()) {
            return this._handleNoAccessError("getSubscriptionTransactions");
        }
        let params = {
            from,
            till
        };
        if (strategyIds) {
            params.strategyId = strategyIds;
        }
        if (subscriberIds) {
            params.subscriberId = subscriberIds;
        }
        if (offset !== undefined) {
            params.offset = offset;
        }
        if (limit) {
            params.limit = limit;
        }
        const opts = {
            url: "/users/current/subscription-transactions",
            method: "GET",
            headers: {
                "auth-token": this._token
            },
            params,
            json: true
        };
        let transactions = await this._domainClient.requestCopyFactory(opts, true);
        transactions.forEach((t)=>t.time = new Date(t.time));
        return transactions;
    }
    /**
   * Adds a strategy transaction listener and creates a job to make requests
   * @param {TransactionListener} listener transaction listener
   * @param {String} strategyId strategy id
   * @param {Date} [startTime] transaction search start time
   * @return {String} listener id
   */ addStrategyTransactionListener(listener, strategyId, startTime) {
        return this._transactionListenerManager.addStrategyTransactionListener(listener, strategyId, startTime);
    }
    /**
   * Removes strategy transaction listener and cancels the event stream
   * @param {String} listenerId strategy transaction listener id
   */ removeStrategyTransactionListener(listenerId) {
        this._transactionListenerManager.removeStrategyTransactionListener(listenerId);
    }
    /**
   * Adds a subscriber transaction listener and creates a job to make requests
   * @param {TransactionListener} listener transaction listener
   * @param {String} subscriberId subscriber id
   * @param {Date} [startTime] transaction search start time
   * @return {String} listener id
   */ addSubscriberTransactionListener(listener, subscriberId, startTime) {
        return this._transactionListenerManager.addSubscriberTransactionListener(listener, subscriberId, startTime);
    }
    /**
   * Removes subscriber transaction listener and cancels the event stream
   * @param {String} listenerId subscriber transaction listener id
   */ removeSubscriberTransactionListener(listenerId) {
        this._transactionListenerManager.removeSubscriberTransactionListener(listenerId);
    }
    /**
   * Constructs CopyFactory history API client instance
   * @param {DomainClient} domainClient domain client
   */ constructor(domainClient){
        super(domainClient);
        this._domainClient = domainClient;
        this._transactionListenerManager = new _transactionListenerManager.default(domainClient);
    }
};

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIjxhbm9uPiJdLCJzb3VyY2VzQ29udGVudCI6WyIndXNlIHN0cmljdCc7XG5cbmltcG9ydCBNZXRhQXBpQ2xpZW50IGZyb20gJy4uL21ldGFBcGkuY2xpZW50JztcbmltcG9ydCBUcmFuc2FjdGlvbkxpc3RlbmVyTWFuYWdlciBmcm9tICcuL3N0cmVhbWluZy90cmFuc2FjdGlvbkxpc3RlbmVyTWFuYWdlcic7XG5cbi8qKlxuICogbWV0YWFwaS5jbG91ZCBDb3B5RmFjdG9yeSBoaXN0b3J5IEFQSSAodHJhZGUgY29weWluZyBoaXN0b3J5IEFQSSkgY2xpZW50IChzZWVcbiAqIGh0dHBzOi8vbWV0YWFwaS5jbG91ZC9kb2NzL2NvcHlmYWN0b3J5LylcbiAqL1xuZXhwb3J0IGRlZmF1bHQgY2xhc3MgSGlzdG9yeUNsaWVudCBleHRlbmRzIE1ldGFBcGlDbGllbnQge1xuXG4gIC8qKlxuICAgKiBDb25zdHJ1Y3RzIENvcHlGYWN0b3J5IGhpc3RvcnkgQVBJIGNsaWVudCBpbnN0YW5jZVxuICAgKiBAcGFyYW0ge0RvbWFpbkNsaWVudH0gZG9tYWluQ2xpZW50IGRvbWFpbiBjbGllbnRcbiAgICovXG4gIGNvbnN0cnVjdG9yKGRvbWFpbkNsaWVudCkge1xuICAgIHN1cGVyKGRvbWFpbkNsaWVudCk7XG4gICAgdGhpcy5fZG9tYWluQ2xpZW50ID0gZG9tYWluQ2xpZW50O1xuICAgIHRoaXMuX3RyYW5zYWN0aW9uTGlzdGVuZXJNYW5hZ2VyID0gbmV3IFRyYW5zYWN0aW9uTGlzdGVuZXJNYW5hZ2VyKGRvbWFpbkNsaWVudCk7XG4gIH1cblxuICAvKipcbiAgICogQ29weUZhY3RvcnkgcHJvdmlkZXIgb3Igc3Vic2NyaWJlciB1c2VyXG4gICAqIEB0eXBlZGVmIHtPYmplY3R9IENvcHlGYWN0b3J5U3Vic2NyaWJlck9yUHJvdmlkZXJVc2VyXG4gICAqIEBwcm9wZXJ0eSB7U3RyaW5nfSBpZCBwcm9maWxlIGlkXG4gICAqIEBwcm9wZXJ0eSB7U3RyaW5nfSBuYW1lIHVzZXIgbmFtZVxuICAgKiBAcHJvcGVydHkge0FycmF5PENvcHlGYWN0b3J5U3RyYXRlZ3lJZEFuZE5hbWU+fSBzdHJhdGVnaWVzIGFycmF5IG9mIHN0cmF0ZWd5IElEcyBwcm92aWRlZCBieSBwcm92aWRlclxuICAgKiBvciBzdWJzY3JpYmVkIHRvIGJ5IHN1YnNjcmliZXJcbiAgICovXG5cbiAgLyoqXG4gICAqIENvcHlGYWN0b3J5IHN0cmF0ZWd5IGlkIGFuZCBuYW1lXG4gICAqIEB0eXBlZGVmIHtPYmplY3R9IENvcHlGYWN0b3J5U3RyYXRlZ3lJZEFuZE5hbWVcbiAgICogQHByb3BlcnR5IHtTdHJpbmd9IGlkIHVuaXF1ZSBzdHJhdGVneSBpZFxuICAgKiBAcHJvcGVydHkge1N0cmluZ30gbmFtZSBodW1hbi1yZWFkYWJsZSBzdHJhdGVneSBuYW1lXG4gICAqL1xuXG4gIC8qKlxuICAgKiBDb3B5RmFjdG9yeSB0cmFuc2FjdGlvblxuICAgKiBAdHlwZWRlZiB7T2JqZWN0fSBDb3B5RmFjdG9yeVRyYW5zYWN0aW9uXG4gICAqIEBwcm9wZXJ0eSB7U3RyaW5nfSBpZCB0cmFuc2FjdGlvbiBpZFxuICAgKiBAcHJvcGVydHkge1N0cmluZ30gdHlwZSB0cmFuc2FjdGlvbiB0eXBlIChvbmUgb2YgREVBTF9UWVBFX0JVWSwgREVBTF9UWVBFX1NFTEwsIERFQUxfVFlQRV9CQUxBTkNFLFxuICAgKiBERUFMX1RZUEVfQ1JFRElULCBERUFMX1RZUEVfQ0hBUkdFLCBERUFMX1RZUEVfQ09SUkVDVElPTiwgREVBTF9UWVBFX0JPTlVTLCBERUFMX1RZUEVfQ09NTUlTU0lPTixcbiAgICogREVBTF9UWVBFX0NPTU1JU1NJT05fREFJTFksIERFQUxfVFlQRV9DT01NSVNTSU9OX01PTlRITFksIERFQUxfVFlQRV9DT01NSVNTSU9OX0FHRU5UX0RBSUxZLFxuICAgKiBERUFMX1RZUEVfQ09NTUlTU0lPTl9BR0VOVF9NT05USExZLCBERUFMX1RZUEVfSU5URVJFU1QsIERFQUxfVFlQRV9CVVlfQ0FOQ0VMRUQsIERFQUxfVFlQRV9TRUxMX0NBTkNFTEVELFxuICAgKiBERUFMX0RJVklERU5ELCBERUFMX0RJVklERU5EX0ZSQU5LRUQsIERFQUxfVEFYKS4gU2VlXG4gICAqIGh0dHBzOi8vd3d3Lm1xbDUuY29tL2VuL2RvY3MvY29uc3RhbnRzL3RyYWRpbmdjb25zdGFudHMvZGVhbHByb3BlcnRpZXMjZW51bV9kZWFsX3R5cGVcbiAgICogQHByb3BlcnR5IHtEYXRlfSB0aW1lIHRyYW5zYWN0aW9uIHRpbWVcbiAgICogQHByb3BlcnR5IHtTdHJpbmd9IHN1YnNjcmliZXJJZCBDb3B5RmFjdG9yeSBzdWJzY3JpYmVyIGlkXG4gICAqIEBwcm9wZXJ0eSB7U3RyaW5nfSBbc3ltYm9sXSBzeW1ib2wgdHJhZGVkXG4gICAqIEBwcm9wZXJ0eSB7Q29weUZhY3RvcnlTdWJzY3JpYmVyT3JQcm92aWRlclVzZXJ9IHN1YnNjcmliZXJVc2VyIHN0cmF0ZWd5IHN1YnNjcmliZXJcbiAgICogQHByb3BlcnR5IHtCb29sZWFufSBkZW1vIGRlbW8gYWNjb3VudCBmbGFnXG4gICAqIEBwcm9wZXJ0eSB7Q29weUZhY3RvcnlTdWJzY3JpYmVyT3JQcm92aWRlclVzZXJ9IHByb3ZpZGVyVXNlciBzdHJhdGVneSBwcm92aWRlclxuICAgKiBAcHJvcGVydHkge0NvcHlGYWN0b3J5U3RyYXRlZ3lJZEFuZE5hbWV9IHN0cmF0ZWd5IHN0cmF0ZWd5XG4gICAqIEBwcm9wZXJ0eSB7U3RyaW5nfSBbcG9zaXRpb25JZF0gc291cmNlIHBvc2l0aW9uIGlkXG4gICAqIEBwcm9wZXJ0eSB7U3RyaW5nfSBbc2xhdmVQb3NpdGlvbklkXSBzbGF2ZSBwb3NpdGlvbiBpZFxuICAgKiBAcHJvcGVydHkge051bWJlcn0gaW1wcm92ZW1lbnQgaGlnaC13YXRlciBtYXJrIHN0cmF0ZWd5IGJhbGFuY2UgaW1wcm92ZW1lbnRcbiAgICogQHByb3BlcnR5IHtOdW1iZXJ9IHByb3ZpZGVyQ29tbWlzc2lvbiBwcm92aWRlciBjb21taXNzaW9uXG4gICAqIEBwcm9wZXJ0eSB7TnVtYmVyfSBwbGF0Zm9ybUNvbW1pc3Npb24gcGxhdGZvcm0gY29tbWlzc2lvblxuICAgKiBAcHJvcGVydHkge051bWJlcn0gW2luY29taW5nUHJvdmlkZXJDb21taXNzaW9uXSBjb21taXNzaW9uIHBhaWQgYnkgcHJvdmlkZXIgdG8gdW5kZXJseWluZyBwcm92aWRlcnNcbiAgICogQHByb3BlcnR5IHtOdW1iZXJ9IFtpbmNvbWluZ1BsYXRmb3JtQ29tbWlzc2lvbl0gcGxhdGZvcm0gY29tbWlzc2lvbiBwYWlkIGJ5IHByb3ZpZGVyIHRvIHVuZGVybHlpbmcgcHJvdmlkZXJzXG4gICAqIEBwcm9wZXJ0eSB7TnVtYmVyfSBbcXVhbnRpdHldIHRyYWRlIHZvbHVtZVxuICAgKiBAcHJvcGVydHkge051bWJlcn0gW2xvdFByaWNlXSB0cmFkZSBsb3QgcHJpY2VcbiAgICogQHByb3BlcnR5IHtOdW1iZXJ9IFt0aWNrUHJpY2VdIHRyYWRlIHRpY2sgcHJpY2VcbiAgICogQHByb3BlcnR5IHtOdW1iZXJ9IFthbW91bnRdIHRyYWRlIGFtb3VudFxuICAgKiBAcHJvcGVydHkge051bWJlcn0gW2NvbW1pc3Npb25dIHRyYWRlIGNvbW1pc3Npb25cbiAgICogQHByb3BlcnR5IHtOdW1iZXJ9IHN3YXAgdHJhZGUgc3dhcFxuICAgKiBAcHJvcGVydHkge051bWJlcn0gcHJvZml0IHRyYWRlIHByb2ZpdFxuICAgKiBAcHJvcGVydHkge0NvcHlGYWN0b3J5VHJhbnNhY3Rpb25NZXRyaWNzfSBbbWV0cmljc10gdHJhZGUgY29weWluZyBtZXRyaWNzIHN1Y2ggYXMgc2xpcHBhZ2UgYW5kIGxhdGVuY2llcy4gTWVhc3VyZWRcbiAgICogc2VsZWN0aXZlbHkgZm9yIGNvcGllZCB0cmFkZXNcbiAgICovXG5cbiAgLyoqXG4gICAqIFRyYWRlIGNvcHlpbmcgbWV0cmljcyBzdWNoIGFzIHNsaXBwYWdlIGFuZCBsYXRlbmNpZXNcbiAgICogQHR5cGVkZWYge09iamVjdH0gQ29weUZhY3RvcnlUcmFuc2FjdGlvbk1ldHJpY3NcbiAgICogQHByb3BlcnR5IHtOdW1iZXJ9IFt0cmFkZUNvcHlpbmdMYXRlbmN5XSB0cmFkZSBjb3B5aW5nIGxhdGVuY3ksIG1lYXN1cmVkIGluIG1pbGxpc2Vjb25kcyBiYXNlZCBvbiB0cmFuc2FjdGlvbiB0aW1lXG4gICAqIHByb3ZpZGVkIGJ5IGJyb2tlclxuICAgKiBAcHJvcGVydHkge051bWJlcn0gW3RyYWRlQ29weWluZ1NsaXBwYWdlSW5CYXNpc1BvaW50c10gdHJhZGUgY29weWluZyBzbGlwcGFnZSwgbWVhc3VyZWQgaW4gYmFzaXMgcG9pbnRzICgwLjAxXG4gICAqIHBlcmNlbnQpIGJhc2VkIG9uIHRyYW5zYWN0aW9uIHByaWNlIHByb3ZpZGVkIGJ5IGJyb2tlclxuICAgKiBAcHJvcGVydHkge051bWJlcn0gW3RyYWRlQ29weWluZ1NsaXBwYWdlSW5BY2NvdW50Q3VycmVuY3ldIHRyYWRlIGNvcHlpbmcgc2xpcHBhZ2UsIG1lYXN1cmVkIGluIGFjY291bnQgY3VycmVuY3lcbiAgICogYmFzZWQgb24gdHJhbnNhY3Rpb24gcHJpY2UgcHJvdmlkZWQgYnkgYnJva2VyXG4gICAqIEBwcm9wZXJ0eSB7TnVtYmVyfSBbbXRBbmRCcm9rZXJTaWduYWxMYXRlbmN5XSB0cmFkZSBzaWduYWwgbGF0ZW5jeSBpbnRyb2R1Y2VkIGJ5IGJyb2tlciBhbmQgTVQgcGxhdGZvcm0sIG1lYXN1cmVkXG4gICAqIGluIG1pbGxpc2Vjb25kc1xuICAgKiBAcHJvcGVydHkge051bWJlcn0gW3RyYWRlQWxnb3JpdGhtTGF0ZW5jeV0gdHJhZGUgYWxnb3JpdGhtIGxhdGVuY3kgaW50cm9kdWNlZCBieSBDb3B5RmFjdG9yeSBzZXJ2ZXJzLCBtZWFzdXJlZCBpblxuICAgKiBtaWxsaXNlY29uZHNcbiAgICogQHByb3BlcnR5IHtOdW1iZXJ9IFttdEFuZEJyb2tlclRyYWRlTGF0ZW5jeV0gdHJhZGUgbGF0ZW5jeSBmb3IgYSBjb3BpZWQgdHJhZGUgaW50cm9kdWNlZCBieSBicm9rZXIgYW5kIE1UIHBsYXRmb3JtLFxuICAgKiBtZWFzdXJlZCBpbiBtaWxsaXNlY29uZHNcbiAgICovXG5cbiAgLyoqXG4gICAqIFJldHVybnMgbGlzdCBvZiB0cmFuc2FjdGlvbnMgb24gdGhlIHN0cmF0ZWdpZXMgdGhlIGN1cnJlbnQgdXNlciBwcm92aWRlcyB0byBvdGhlciB1c2Vyc1xuICAgKiBodHRwczovL21ldGFhcGkuY2xvdWQvZG9jcy9jb3B5ZmFjdG9yeS9yZXN0QXBpL2FwaS9oaXN0b3J5L2dldFByb3ZpZGVkVHJhbnNhY3Rpb25zL1xuICAgKiBAcGFyYW0ge0RhdGV9IGZyb20gdGltZSB0byBsb2FkIHRyYW5zYWN0aW9ucyBmcm9tXG4gICAqIEBwYXJhbSB7RGF0ZX0gdGlsbCB0aW1lIHRvIGxvYWQgdHJhbnNhY3Rpb25zIHRpbGxcbiAgICogQHBhcmFtIHtBcnJheTxzdHJpbmc+fSBbc3RyYXRlZ3lJZHNdIGxpc3Qgb2Ygc3RyYXRlZ3kgaWRzIHRvIGZpbHRlciB0cmFuc2FjdGlvbnMgYnlcbiAgICogQHBhcmFtIHtBcnJheTxzdHJpbmc+fSBbc3Vic2NyaWJlcklkc10gdGhlIGxpc3Qgb2YgQ29weUZhY3Rvcnkgc3Vic2NyaWJlciBhY2NvdW50IGlkcyB0byBmaWx0ZXIgYnlcbiAgICogQHBhcmFtIHtudW1iZXJ9IFtvZmZzZXRdIHBhZ2luYXRpb24gb2Zmc2V0LiBEZWZhdWx0IHZhbHVlIGlzIDBcbiAgICogQHBhcmFtIHtudW1iZXJ9IFtsaW1pdF0gcGFnaW5hdGlvbiBsaW1pdC4gRGVmYXVsdCB2YWx1ZSBpcyAxMDAwXG4gICAqIEByZXR1cm4ge1Byb21pc2U8QXJyYXk8Q29weUZhY3RvcnlUcmFuc2FjdGlvbj4+fSBwcm9taXNlIHJlc29sdmluZyB3aXRoIHRyYW5zYWN0aW9ucyBmb3VuZFxuICAgKi9cbiAgYXN5bmMgZ2V0UHJvdmlkZWRUcmFuc2FjdGlvbnMoZnJvbSwgdGlsbCwgc3RyYXRlZ3lJZHMsIHN1YnNjcmliZXJJZHMsIG9mZnNldCwgbGltaXQpIHtcbiAgICBpZiAodGhpcy5faXNOb3RKd3RUb2tlbigpKSB7XG4gICAgICByZXR1cm4gdGhpcy5faGFuZGxlTm9BY2Nlc3NFcnJvcignZ2V0UHJvdmlkZWRUcmFuc2FjdGlvbnMnKTtcbiAgICB9XG4gICAgbGV0IHBhcmFtcyA9IHtcbiAgICAgIGZyb20sXG4gICAgICB0aWxsXG4gICAgfTtcbiAgICBpZiAoc3RyYXRlZ3lJZHMpIHtcbiAgICAgIHBhcmFtcy5zdHJhdGVneUlkID0gc3RyYXRlZ3lJZHM7XG4gICAgfVxuICAgIGlmIChzdWJzY3JpYmVySWRzKSB7XG4gICAgICBwYXJhbXMuc3Vic2NyaWJlcklkID0gc3Vic2NyaWJlcklkcztcbiAgICB9XG4gICAgaWYgKG9mZnNldCAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICBwYXJhbXMub2Zmc2V0ID0gb2Zmc2V0O1xuICAgIH1cbiAgICBpZiAobGltaXQpIHtcbiAgICAgIHBhcmFtcy5saW1pdCA9IGxpbWl0O1xuICAgIH1cbiAgICBjb25zdCBvcHRzID0ge1xuICAgICAgdXJsOiAnL3VzZXJzL2N1cnJlbnQvcHJvdmlkZWQtdHJhbnNhY3Rpb25zJyxcbiAgICAgIG1ldGhvZDogJ0dFVCcsXG4gICAgICBoZWFkZXJzOiB7XG4gICAgICAgICdhdXRoLXRva2VuJzogdGhpcy5fdG9rZW5cbiAgICAgIH0sXG4gICAgICBwYXJhbXMsXG4gICAgICBqc29uOiB0cnVlXG4gICAgfTtcbiAgICBsZXQgdHJhbnNhY3Rpb25zID0gYXdhaXQgdGhpcy5fZG9tYWluQ2xpZW50LnJlcXVlc3RDb3B5RmFjdG9yeShvcHRzLCB0cnVlKTtcbiAgICB0cmFuc2FjdGlvbnMuZm9yRWFjaCh0ID0+IHQudGltZSA9IG5ldyBEYXRlKHQudGltZSkpO1xuICAgIHJldHVybiB0cmFuc2FjdGlvbnM7XG4gIH1cblxuICAvKipcbiAgICogUmV0dXJucyBsaXN0IG9mIHRyYWRlcyBvbiB0aGUgc3RyYXRlZ2llcyB0aGUgY3VycmVudCB1c2VyIHN1YnNjcmliZWQgdG9cbiAgICogaHR0cHM6Ly9tZXRhYXBpLmNsb3VkL2RvY3MvY29weWZhY3RvcnkvcmVzdEFwaS9hcGkvaGlzdG9yeS9nZXRTdWJzY3JpcHRpb25UcmFuc2FjdGlvbnMvXG4gICAqIEBwYXJhbSB7RGF0ZX0gZnJvbSB0aW1lIHRvIGxvYWQgdHJhbnNhY3Rpb25zIGZyb21cbiAgICogQHBhcmFtIHtEYXRlfSB0aWxsIHRpbWUgdG8gbG9hZCB0cmFuc2FjdGlvbnMgdGlsbFxuICAgKiBAcGFyYW0ge0FycmF5PFN0cmluZz59IFtzdHJhdGVneUlkc10gbGlzdCBvZiBzdHJhdGVneSBpZHMgdG8gZmlsdGVyIHRyYW5zYWN0aW9ucyBieVxuICAgKiBAcGFyYW0ge0FycmF5PHN0cmluZz59IFtzdWJzY3JpYmVySWRzXSB0aGUgbGlzdCBvZiBDb3B5RmFjdG9yeSBzdWJzY3JpYmVyIGFjY291bnQgaWRzIHRvIGZpbHRlciBieVxuICAgKiBAcGFyYW0ge051bWJlcn0gb2Zmc2V0IHBhZ2luYXRpb24gb2Zmc2V0LiBEZWZhdWx0IHZhbHVlIGlzIDBcbiAgICogQHBhcmFtIHtOdW1iZXJ9IGxpbWl0IHBhZ2luYXRpb24gbGltaXQuIERlZmF1bHQgdmFsdWUgaXMgMTAwMFxuICAgKiBAcmV0dXJuIHtQcm9taXNlPEFycmF5PENvcHlGYWN0b3J5VHJhbnNhY3Rpb24+Pn0gcHJvbWlzZSByZXNvbHZpbmcgd2l0aCB0cmFuc2FjdGlvbnMgZm91bmRcbiAgICovXG4gIGFzeW5jIGdldFN1YnNjcmlwdGlvblRyYW5zYWN0aW9ucyhmcm9tLCB0aWxsLCBzdHJhdGVneUlkcywgc3Vic2NyaWJlcklkcywgb2Zmc2V0LCBsaW1pdCkge1xuICAgIGlmICh0aGlzLl9pc05vdEp3dFRva2VuKCkpIHtcbiAgICAgIHJldHVybiB0aGlzLl9oYW5kbGVOb0FjY2Vzc0Vycm9yKCdnZXRTdWJzY3JpcHRpb25UcmFuc2FjdGlvbnMnKTtcbiAgICB9XG4gICAgbGV0IHBhcmFtcyA9IHtcbiAgICAgIGZyb20sXG4gICAgICB0aWxsXG4gICAgfTtcbiAgICBpZiAoc3RyYXRlZ3lJZHMpIHtcbiAgICAgIHBhcmFtcy5zdHJhdGVneUlkID0gc3RyYXRlZ3lJZHM7XG4gICAgfVxuICAgIGlmIChzdWJzY3JpYmVySWRzKSB7XG4gICAgICBwYXJhbXMuc3Vic2NyaWJlcklkID0gc3Vic2NyaWJlcklkcztcbiAgICB9XG4gICAgaWYgKG9mZnNldCAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICBwYXJhbXMub2Zmc2V0ID0gb2Zmc2V0O1xuICAgIH1cbiAgICBpZiAobGltaXQpIHtcbiAgICAgIHBhcmFtcy5saW1pdCA9IGxpbWl0O1xuICAgIH1cbiAgICBjb25zdCBvcHRzID0ge1xuICAgICAgdXJsOiAnL3VzZXJzL2N1cnJlbnQvc3Vic2NyaXB0aW9uLXRyYW5zYWN0aW9ucycsXG4gICAgICBtZXRob2Q6ICdHRVQnLFxuICAgICAgaGVhZGVyczoge1xuICAgICAgICAnYXV0aC10b2tlbic6IHRoaXMuX3Rva2VuXG4gICAgICB9LFxuICAgICAgcGFyYW1zLFxuICAgICAganNvbjogdHJ1ZVxuICAgIH07XG4gICAgbGV0IHRyYW5zYWN0aW9ucyA9IGF3YWl0IHRoaXMuX2RvbWFpbkNsaWVudC5yZXF1ZXN0Q29weUZhY3Rvcnkob3B0cywgdHJ1ZSk7XG4gICAgdHJhbnNhY3Rpb25zLmZvckVhY2godCA9PiB0LnRpbWUgPSBuZXcgRGF0ZSh0LnRpbWUpKTtcbiAgICByZXR1cm4gdHJhbnNhY3Rpb25zO1xuICB9XG5cbiAgLyoqXG4gICAqIEFkZHMgYSBzdHJhdGVneSB0cmFuc2FjdGlvbiBsaXN0ZW5lciBhbmQgY3JlYXRlcyBhIGpvYiB0byBtYWtlIHJlcXVlc3RzXG4gICAqIEBwYXJhbSB7VHJhbnNhY3Rpb25MaXN0ZW5lcn0gbGlzdGVuZXIgdHJhbnNhY3Rpb24gbGlzdGVuZXJcbiAgICogQHBhcmFtIHtTdHJpbmd9IHN0cmF0ZWd5SWQgc3RyYXRlZ3kgaWRcbiAgICogQHBhcmFtIHtEYXRlfSBbc3RhcnRUaW1lXSB0cmFuc2FjdGlvbiBzZWFyY2ggc3RhcnQgdGltZVxuICAgKiBAcmV0dXJuIHtTdHJpbmd9IGxpc3RlbmVyIGlkXG4gICAqL1xuICBhZGRTdHJhdGVneVRyYW5zYWN0aW9uTGlzdGVuZXIobGlzdGVuZXIsIHN0cmF0ZWd5SWQsIHN0YXJ0VGltZSkge1xuICAgIHJldHVybiB0aGlzLl90cmFuc2FjdGlvbkxpc3RlbmVyTWFuYWdlci5hZGRTdHJhdGVneVRyYW5zYWN0aW9uTGlzdGVuZXIobGlzdGVuZXIsIHN0cmF0ZWd5SWQsIHN0YXJ0VGltZSk7XG4gIH1cblxuICAvKipcbiAgICogUmVtb3ZlcyBzdHJhdGVneSB0cmFuc2FjdGlvbiBsaXN0ZW5lciBhbmQgY2FuY2VscyB0aGUgZXZlbnQgc3RyZWFtXG4gICAqIEBwYXJhbSB7U3RyaW5nfSBsaXN0ZW5lcklkIHN0cmF0ZWd5IHRyYW5zYWN0aW9uIGxpc3RlbmVyIGlkXG4gICAqL1xuICByZW1vdmVTdHJhdGVneVRyYW5zYWN0aW9uTGlzdGVuZXIobGlzdGVuZXJJZCkge1xuICAgIHRoaXMuX3RyYW5zYWN0aW9uTGlzdGVuZXJNYW5hZ2VyLnJlbW92ZVN0cmF0ZWd5VHJhbnNhY3Rpb25MaXN0ZW5lcihsaXN0ZW5lcklkKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBBZGRzIGEgc3Vic2NyaWJlciB0cmFuc2FjdGlvbiBsaXN0ZW5lciBhbmQgY3JlYXRlcyBhIGpvYiB0byBtYWtlIHJlcXVlc3RzXG4gICAqIEBwYXJhbSB7VHJhbnNhY3Rpb25MaXN0ZW5lcn0gbGlzdGVuZXIgdHJhbnNhY3Rpb24gbGlzdGVuZXJcbiAgICogQHBhcmFtIHtTdHJpbmd9IHN1YnNjcmliZXJJZCBzdWJzY3JpYmVyIGlkXG4gICAqIEBwYXJhbSB7RGF0ZX0gW3N0YXJ0VGltZV0gdHJhbnNhY3Rpb24gc2VhcmNoIHN0YXJ0IHRpbWVcbiAgICogQHJldHVybiB7U3RyaW5nfSBsaXN0ZW5lciBpZFxuICAgKi9cbiAgYWRkU3Vic2NyaWJlclRyYW5zYWN0aW9uTGlzdGVuZXIobGlzdGVuZXIsIHN1YnNjcmliZXJJZCwgc3RhcnRUaW1lKSB7XG4gICAgcmV0dXJuIHRoaXMuX3RyYW5zYWN0aW9uTGlzdGVuZXJNYW5hZ2VyLmFkZFN1YnNjcmliZXJUcmFuc2FjdGlvbkxpc3RlbmVyKGxpc3RlbmVyLCBzdWJzY3JpYmVySWQsIHN0YXJ0VGltZSk7XG4gIH1cblxuICAvKipcbiAgICogUmVtb3ZlcyBzdWJzY3JpYmVyIHRyYW5zYWN0aW9uIGxpc3RlbmVyIGFuZCBjYW5jZWxzIHRoZSBldmVudCBzdHJlYW1cbiAgICogQHBhcmFtIHtTdHJpbmd9IGxpc3RlbmVySWQgc3Vic2NyaWJlciB0cmFuc2FjdGlvbiBsaXN0ZW5lciBpZFxuICAgKi9cbiAgcmVtb3ZlU3Vic2NyaWJlclRyYW5zYWN0aW9uTGlzdGVuZXIobGlzdGVuZXJJZCkge1xuICAgIHRoaXMuX3RyYW5zYWN0aW9uTGlzdGVuZXJNYW5hZ2VyLnJlbW92ZVN1YnNjcmliZXJUcmFuc2FjdGlvbkxpc3RlbmVyKGxpc3RlbmVySWQpO1xuICB9XG5cbn1cbiJdLCJuYW1lcyI6WyJIaXN0b3J5Q2xpZW50IiwiTWV0YUFwaUNsaWVudCIsImdldFByb3ZpZGVkVHJhbnNhY3Rpb25zIiwiZnJvbSIsInRpbGwiLCJzdHJhdGVneUlkcyIsInN1YnNjcmliZXJJZHMiLCJvZmZzZXQiLCJsaW1pdCIsIl9pc05vdEp3dFRva2VuIiwiX2hhbmRsZU5vQWNjZXNzRXJyb3IiLCJwYXJhbXMiLCJzdHJhdGVneUlkIiwic3Vic2NyaWJlcklkIiwidW5kZWZpbmVkIiwib3B0cyIsInVybCIsIm1ldGhvZCIsImhlYWRlcnMiLCJfdG9rZW4iLCJqc29uIiwidHJhbnNhY3Rpb25zIiwiX2RvbWFpbkNsaWVudCIsInJlcXVlc3RDb3B5RmFjdG9yeSIsImZvckVhY2giLCJ0IiwidGltZSIsIkRhdGUiLCJnZXRTdWJzY3JpcHRpb25UcmFuc2FjdGlvbnMiLCJhZGRTdHJhdGVneVRyYW5zYWN0aW9uTGlzdGVuZXIiLCJsaXN0ZW5lciIsInN0YXJ0VGltZSIsIl90cmFuc2FjdGlvbkxpc3RlbmVyTWFuYWdlciIsInJlbW92ZVN0cmF0ZWd5VHJhbnNhY3Rpb25MaXN0ZW5lciIsImxpc3RlbmVySWQiLCJhZGRTdWJzY3JpYmVyVHJhbnNhY3Rpb25MaXN0ZW5lciIsInJlbW92ZVN1YnNjcmliZXJUcmFuc2FjdGlvbkxpc3RlbmVyIiwiY29uc3RydWN0b3IiLCJkb21haW5DbGllbnQiLCJUcmFuc2FjdGlvbkxpc3RlbmVyTWFuYWdlciJdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7Ozs7ZUFTcUJBOzs7c0VBUEs7bUZBQ2E7Ozs7OztBQU14QixJQUFBLEFBQU1BLGdCQUFOLE1BQU1BLHNCQUFzQkMsc0JBQWE7SUFZdEQ7Ozs7Ozs7R0FPQyxHQUVEOzs7OztHQUtDLEdBRUQ7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztHQWlDQyxHQUVEOzs7Ozs7Ozs7Ozs7Ozs7R0FlQyxHQUVEOzs7Ozs7Ozs7O0dBVUMsR0FDRCxNQUFNQyx3QkFBd0JDLElBQUksRUFBRUMsSUFBSSxFQUFFQyxXQUFXLEVBQUVDLGFBQWEsRUFBRUMsTUFBTSxFQUFFQyxLQUFLLEVBQUU7UUFDbkYsSUFBSSxJQUFJLENBQUNDLGNBQWMsSUFBSTtZQUN6QixPQUFPLElBQUksQ0FBQ0Msb0JBQW9CLENBQUM7UUFDbkM7UUFDQSxJQUFJQyxTQUFTO1lBQ1hSO1lBQ0FDO1FBQ0Y7UUFDQSxJQUFJQyxhQUFhO1lBQ2ZNLE9BQU9DLFVBQVUsR0FBR1A7UUFDdEI7UUFDQSxJQUFJQyxlQUFlO1lBQ2pCSyxPQUFPRSxZQUFZLEdBQUdQO1FBQ3hCO1FBQ0EsSUFBSUMsV0FBV08sV0FBVztZQUN4QkgsT0FBT0osTUFBTSxHQUFHQTtRQUNsQjtRQUNBLElBQUlDLE9BQU87WUFDVEcsT0FBT0gsS0FBSyxHQUFHQTtRQUNqQjtRQUNBLE1BQU1PLE9BQU87WUFDWEMsS0FBSztZQUNMQyxRQUFRO1lBQ1JDLFNBQVM7Z0JBQ1AsY0FBYyxJQUFJLENBQUNDLE1BQU07WUFDM0I7WUFDQVI7WUFDQVMsTUFBTTtRQUNSO1FBQ0EsSUFBSUMsZUFBZSxNQUFNLElBQUksQ0FBQ0MsYUFBYSxDQUFDQyxrQkFBa0IsQ0FBQ1IsTUFBTTtRQUNyRU0sYUFBYUcsT0FBTyxDQUFDQyxDQUFBQSxJQUFLQSxFQUFFQyxJQUFJLEdBQUcsSUFBSUMsS0FBS0YsRUFBRUMsSUFBSTtRQUNsRCxPQUFPTDtJQUNUO0lBRUE7Ozs7Ozs7Ozs7R0FVQyxHQUNELE1BQU1PLDRCQUE0QnpCLElBQUksRUFBRUMsSUFBSSxFQUFFQyxXQUFXLEVBQUVDLGFBQWEsRUFBRUMsTUFBTSxFQUFFQyxLQUFLLEVBQUU7UUFDdkYsSUFBSSxJQUFJLENBQUNDLGNBQWMsSUFBSTtZQUN6QixPQUFPLElBQUksQ0FBQ0Msb0JBQW9CLENBQUM7UUFDbkM7UUFDQSxJQUFJQyxTQUFTO1lBQ1hSO1lBQ0FDO1FBQ0Y7UUFDQSxJQUFJQyxhQUFhO1lBQ2ZNLE9BQU9DLFVBQVUsR0FBR1A7UUFDdEI7UUFDQSxJQUFJQyxlQUFlO1lBQ2pCSyxPQUFPRSxZQUFZLEdBQUdQO1FBQ3hCO1FBQ0EsSUFBSUMsV0FBV08sV0FBVztZQUN4QkgsT0FBT0osTUFBTSxHQUFHQTtRQUNsQjtRQUNBLElBQUlDLE9BQU87WUFDVEcsT0FBT0gsS0FBSyxHQUFHQTtRQUNqQjtRQUNBLE1BQU1PLE9BQU87WUFDWEMsS0FBSztZQUNMQyxRQUFRO1lBQ1JDLFNBQVM7Z0JBQ1AsY0FBYyxJQUFJLENBQUNDLE1BQU07WUFDM0I7WUFDQVI7WUFDQVMsTUFBTTtRQUNSO1FBQ0EsSUFBSUMsZUFBZSxNQUFNLElBQUksQ0FBQ0MsYUFBYSxDQUFDQyxrQkFBa0IsQ0FBQ1IsTUFBTTtRQUNyRU0sYUFBYUcsT0FBTyxDQUFDQyxDQUFBQSxJQUFLQSxFQUFFQyxJQUFJLEdBQUcsSUFBSUMsS0FBS0YsRUFBRUMsSUFBSTtRQUNsRCxPQUFPTDtJQUNUO0lBRUE7Ozs7OztHQU1DLEdBQ0RRLCtCQUErQkMsUUFBUSxFQUFFbEIsVUFBVSxFQUFFbUIsU0FBUyxFQUFFO1FBQzlELE9BQU8sSUFBSSxDQUFDQywyQkFBMkIsQ0FBQ0gsOEJBQThCLENBQUNDLFVBQVVsQixZQUFZbUI7SUFDL0Y7SUFFQTs7O0dBR0MsR0FDREUsa0NBQWtDQyxVQUFVLEVBQUU7UUFDNUMsSUFBSSxDQUFDRiwyQkFBMkIsQ0FBQ0MsaUNBQWlDLENBQUNDO0lBQ3JFO0lBRUE7Ozs7OztHQU1DLEdBQ0RDLGlDQUFpQ0wsUUFBUSxFQUFFakIsWUFBWSxFQUFFa0IsU0FBUyxFQUFFO1FBQ2xFLE9BQU8sSUFBSSxDQUFDQywyQkFBMkIsQ0FBQ0csZ0NBQWdDLENBQUNMLFVBQVVqQixjQUFja0I7SUFDbkc7SUFFQTs7O0dBR0MsR0FDREssb0NBQW9DRixVQUFVLEVBQUU7UUFDOUMsSUFBSSxDQUFDRiwyQkFBMkIsQ0FBQ0ksbUNBQW1DLENBQUNGO0lBQ3ZFO0lBNU1BOzs7R0FHQyxHQUNERyxZQUFZQyxZQUFZLENBQUU7UUFDeEIsS0FBSyxDQUFDQTtRQUNOLElBQUksQ0FBQ2hCLGFBQWEsR0FBR2dCO1FBQ3JCLElBQUksQ0FBQ04sMkJBQTJCLEdBQUcsSUFBSU8sbUNBQTBCLENBQUNEO0lBQ3BFO0FBc01GIn0=