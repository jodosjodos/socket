"use strict";
Object.defineProperty(exports, "__esModule", {
    value: true
});
Object.defineProperty(exports, "default", {
    enumerable: true,
    get: function() {
        return UserLogListenerManager;
    }
});
const _metaApiclient = /*#__PURE__*/ _interop_require_default(require("../../metaApi.client"));
const _randomstring = /*#__PURE__*/ _interop_require_default(require("randomstring"));
const _logger = /*#__PURE__*/ _interop_require_default(require("../../../logger"));
function _interop_require_default(obj) {
    return obj && obj.__esModule ? obj : {
        default: obj
    };
}
let UserLogListenerManager = class UserLogListenerManager extends _metaApiclient.default {
    /**
   * Returns the dictionary of strategy log listeners
   * @returns {Object} dictionary of strategy log listeners
   */ get strategyLogListeners() {
        return this._strategyLogListeners;
    }
    /**
   * Returns the dictionary of subscriber log listeners
   * @returns {Object} dictionary of subscriber log listeners
   */ get subscriberLogListeners() {
        return this._subscriberLogListeners;
    }
    /**
   * Adds a strategy log listener
   * @param {UserLogListener} listener user log listener
   * @param {String} strategyId strategy id
   * @param {Date} [startTime] log search start time
   * @param {String} [positionId] position id filter
   * @param {'DEBUG'|'INFO'|'WARN'|'ERROR'} [level] minimum severity level
   * @param {Number} [limit] log pagination limit
   * @returns {String} strategy log listener id
   */ addStrategyLogListener(listener, strategyId, startTime, positionId, level, limit) {
        const listenerId = _randomstring.default.generate(10);
        this._strategyLogListeners[listenerId] = listener;
        this._startStrategyLogStreamJob(listenerId, listener, strategyId, startTime, positionId, level, limit);
        return listenerId;
    }
    /**
   * Adds a subscriber log listener
   * @param {UserLogListener} listener user log listener
   * @param {String} subscriberId subscriber id
   * @param {Date} [startTime] log search start time
   * @param {string} [strategyId] strategy id filter
   * @param {string} [positionId] position id filter
   * @param {'DEBUG'|'INFO'|'WARN'|'ERROR'} [level] minimum severity level
   * @param {Number} [limit] log pagination limit
   * @returns {String} subscriber log listener id
   */ addSubscriberLogListener(listener, subscriberId, startTime, strategyId, positionId, level, limit) {
        const listenerId = _randomstring.default.generate(10);
        this._subscriberLogListeners[listenerId] = listener;
        this._startSubscriberLogStreamJob(listenerId, listener, subscriberId, startTime, strategyId, positionId, level, limit);
        return listenerId;
    }
    /**
   * Removes strategy log listener by id
   * @param {String} listenerId listener id 
   */ removeStrategyLogListener(listenerId) {
        delete this._strategyLogListeners[listenerId];
    }
    /**
   * Removes subscriber log listener by id
   * @param {String} listenerId listener id 
   */ removeSubscriberLogListener(listenerId) {
        delete this._subscriberLogListeners[listenerId];
    }
    async _startStrategyLogStreamJob(listenerId, listener, strategyId, startTime, positionId, level, limit) {
        let throttleTime = this._errorThrottleTime;
        while(this._strategyLogListeners[listenerId]){
            const opts = {
                url: `/users/current/strategies/${strategyId}/user-log/stream`,
                method: "GET",
                params: {
                    startTime,
                    positionId,
                    level,
                    limit
                },
                headers: {
                    "auth-token": this._token
                },
                json: true
            };
            try {
                const packets = await this._domainClient.requestCopyFactory(opts, true);
                // stop job if user has unsubscribed in time of new packets has been received
                if (!this._strategyLogListeners[listenerId]) {
                    return;
                }
                await listener.onUserLog(packets);
                throttleTime = this._errorThrottleTime;
                if (this._strategyLogListeners[listenerId] && packets.length) {
                    startTime = new Date(new Date(packets[0].time).getTime() + 1);
                }
            } catch (err) {
                await listener.onError(err);
                if (err.name === "NotFoundError") {
                    this._logger.error(`Strategy ${strategyId} not found, removing listener ${listenerId}`);
                    delete this._strategyLogListeners[listenerId];
                } else {
                    this._logger.error(`Failed to retrieve user log stream for strategy ${strategyId}, ` + `listener ${listenerId}, retrying in ${Math.floor(throttleTime / 1000)} seconds`, err);
                    await new Promise((res)=>setTimeout(res, throttleTime));
                    throttleTime = Math.min(throttleTime * 2, 30000);
                }
            }
        }
    }
    async _startSubscriberLogStreamJob(listenerId, listener, subscriberId, startTime, strategyId, positionId, level, limit) {
        let throttleTime = this._errorThrottleTime;
        while(this._subscriberLogListeners[listenerId]){
            const opts = {
                url: `/users/current/subscribers/${subscriberId}/user-log/stream`,
                method: "GET",
                params: {
                    startTime,
                    strategyId,
                    positionId,
                    level,
                    limit
                },
                headers: {
                    "auth-token": this._token
                },
                json: true
            };
            try {
                const packets = await this._domainClient.requestCopyFactory(opts, true);
                // stop job if user has unsubscribed in time of new packets has been received
                if (!this._subscriberLogListeners[listenerId]) {
                    return;
                }
                await listener.onUserLog(packets);
                throttleTime = this._errorThrottleTime;
                if (this._subscriberLogListeners[listenerId] && packets.length) {
                    startTime = new Date(new Date(packets[0].time).getTime() + 1);
                }
            } catch (err) {
                await listener.onError(err);
                if (err.name === "NotFoundError") {
                    this._logger.error(`Subscriber ${subscriberId} not found, removing listener ${listenerId}`);
                    delete this._subscriberLogListeners[listenerId];
                } else {
                    this._logger.error(`Failed to retrieve user log stream for subscriber ${subscriberId}, ` + `listener ${listenerId}, retrying in ${Math.floor(throttleTime / 1000)} seconds`, err);
                    await new Promise((res)=>setTimeout(res, throttleTime));
                    throttleTime = Math.min(throttleTime * 2, 30000);
                }
            }
        }
    }
    /**
   * Constructs user log event listener manager instance
   * @param {DomainClient} domainClient domain client
   */ constructor(domainClient){
        super(domainClient);
        this._domainClient = domainClient;
        this._strategyLogListeners = {};
        this._subscriberLogListeners = {};
        this._errorThrottleTime = 1000;
        this._logger = _logger.default.getLogger("UserLogListenerManager");
    }
};

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIjxhbm9uPiJdLCJzb3VyY2VzQ29udGVudCI6WyIndXNlIHN0cmljdCc7XG5cbmltcG9ydCBNZXRhQXBpQ2xpZW50IGZyb20gJy4uLy4uL21ldGFBcGkuY2xpZW50JztcbmltcG9ydCByYW5kb21zdHJpbmcgZnJvbSAncmFuZG9tc3RyaW5nJztcbmltcG9ydCBMb2dnZXJNYW5hZ2VyIGZyb20gJy4uLy4uLy4uL2xvZ2dlcic7XG5cbi8qKlxuICogVXNlciBsb2cgZXZlbnQgbGlzdGVuZXIgbWFuYWdlclxuICovXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBVc2VyTG9nTGlzdGVuZXJNYW5hZ2VyIGV4dGVuZHMgTWV0YUFwaUNsaWVudCB7XG5cbiAgLyoqXG4gICAqIENvbnN0cnVjdHMgdXNlciBsb2cgZXZlbnQgbGlzdGVuZXIgbWFuYWdlciBpbnN0YW5jZVxuICAgKiBAcGFyYW0ge0RvbWFpbkNsaWVudH0gZG9tYWluQ2xpZW50IGRvbWFpbiBjbGllbnRcbiAgICovXG4gIGNvbnN0cnVjdG9yKGRvbWFpbkNsaWVudCkge1xuICAgIHN1cGVyKGRvbWFpbkNsaWVudCk7XG4gICAgdGhpcy5fZG9tYWluQ2xpZW50ID0gZG9tYWluQ2xpZW50O1xuICAgIHRoaXMuX3N0cmF0ZWd5TG9nTGlzdGVuZXJzID0ge307XG4gICAgdGhpcy5fc3Vic2NyaWJlckxvZ0xpc3RlbmVycyA9IHt9O1xuICAgIHRoaXMuX2Vycm9yVGhyb3R0bGVUaW1lID0gMTAwMDtcbiAgICB0aGlzLl9sb2dnZXIgPSBMb2dnZXJNYW5hZ2VyLmdldExvZ2dlcignVXNlckxvZ0xpc3RlbmVyTWFuYWdlcicpO1xuICB9XG5cbiAgLyoqXG4gICAqIFJldHVybnMgdGhlIGRpY3Rpb25hcnkgb2Ygc3RyYXRlZ3kgbG9nIGxpc3RlbmVyc1xuICAgKiBAcmV0dXJucyB7T2JqZWN0fSBkaWN0aW9uYXJ5IG9mIHN0cmF0ZWd5IGxvZyBsaXN0ZW5lcnNcbiAgICovXG4gIGdldCBzdHJhdGVneUxvZ0xpc3RlbmVycygpIHtcbiAgICByZXR1cm4gdGhpcy5fc3RyYXRlZ3lMb2dMaXN0ZW5lcnM7XG4gIH1cblxuICAvKipcbiAgICogUmV0dXJucyB0aGUgZGljdGlvbmFyeSBvZiBzdWJzY3JpYmVyIGxvZyBsaXN0ZW5lcnNcbiAgICogQHJldHVybnMge09iamVjdH0gZGljdGlvbmFyeSBvZiBzdWJzY3JpYmVyIGxvZyBsaXN0ZW5lcnNcbiAgICovXG4gIGdldCBzdWJzY3JpYmVyTG9nTGlzdGVuZXJzKCkge1xuICAgIHJldHVybiB0aGlzLl9zdWJzY3JpYmVyTG9nTGlzdGVuZXJzO1xuICB9XG5cbiAgLyoqXG4gICAqIEFkZHMgYSBzdHJhdGVneSBsb2cgbGlzdGVuZXJcbiAgICogQHBhcmFtIHtVc2VyTG9nTGlzdGVuZXJ9IGxpc3RlbmVyIHVzZXIgbG9nIGxpc3RlbmVyXG4gICAqIEBwYXJhbSB7U3RyaW5nfSBzdHJhdGVneUlkIHN0cmF0ZWd5IGlkXG4gICAqIEBwYXJhbSB7RGF0ZX0gW3N0YXJ0VGltZV0gbG9nIHNlYXJjaCBzdGFydCB0aW1lXG4gICAqIEBwYXJhbSB7U3RyaW5nfSBbcG9zaXRpb25JZF0gcG9zaXRpb24gaWQgZmlsdGVyXG4gICAqIEBwYXJhbSB7J0RFQlVHJ3wnSU5GTyd8J1dBUk4nfCdFUlJPUid9IFtsZXZlbF0gbWluaW11bSBzZXZlcml0eSBsZXZlbFxuICAgKiBAcGFyYW0ge051bWJlcn0gW2xpbWl0XSBsb2cgcGFnaW5hdGlvbiBsaW1pdFxuICAgKiBAcmV0dXJucyB7U3RyaW5nfSBzdHJhdGVneSBsb2cgbGlzdGVuZXIgaWRcbiAgICovXG4gIGFkZFN0cmF0ZWd5TG9nTGlzdGVuZXIobGlzdGVuZXIsIHN0cmF0ZWd5SWQsIHN0YXJ0VGltZSwgcG9zaXRpb25JZCwgbGV2ZWwsIGxpbWl0KSB7XG4gICAgY29uc3QgbGlzdGVuZXJJZCA9IHJhbmRvbXN0cmluZy5nZW5lcmF0ZSgxMCk7XG4gICAgdGhpcy5fc3RyYXRlZ3lMb2dMaXN0ZW5lcnNbbGlzdGVuZXJJZF0gPSBsaXN0ZW5lcjtcbiAgICB0aGlzLl9zdGFydFN0cmF0ZWd5TG9nU3RyZWFtSm9iKGxpc3RlbmVySWQsIGxpc3RlbmVyLCBzdHJhdGVneUlkLCBzdGFydFRpbWUsIHBvc2l0aW9uSWQsIGxldmVsLCBsaW1pdCk7XG4gICAgcmV0dXJuIGxpc3RlbmVySWQ7XG4gIH1cblxuICAvKipcbiAgICogQWRkcyBhIHN1YnNjcmliZXIgbG9nIGxpc3RlbmVyXG4gICAqIEBwYXJhbSB7VXNlckxvZ0xpc3RlbmVyfSBsaXN0ZW5lciB1c2VyIGxvZyBsaXN0ZW5lclxuICAgKiBAcGFyYW0ge1N0cmluZ30gc3Vic2NyaWJlcklkIHN1YnNjcmliZXIgaWRcbiAgICogQHBhcmFtIHtEYXRlfSBbc3RhcnRUaW1lXSBsb2cgc2VhcmNoIHN0YXJ0IHRpbWVcbiAgICogQHBhcmFtIHtzdHJpbmd9IFtzdHJhdGVneUlkXSBzdHJhdGVneSBpZCBmaWx0ZXJcbiAgICogQHBhcmFtIHtzdHJpbmd9IFtwb3NpdGlvbklkXSBwb3NpdGlvbiBpZCBmaWx0ZXJcbiAgICogQHBhcmFtIHsnREVCVUcnfCdJTkZPJ3wnV0FSTid8J0VSUk9SJ30gW2xldmVsXSBtaW5pbXVtIHNldmVyaXR5IGxldmVsXG4gICAqIEBwYXJhbSB7TnVtYmVyfSBbbGltaXRdIGxvZyBwYWdpbmF0aW9uIGxpbWl0XG4gICAqIEByZXR1cm5zIHtTdHJpbmd9IHN1YnNjcmliZXIgbG9nIGxpc3RlbmVyIGlkXG4gICAqL1xuICBhZGRTdWJzY3JpYmVyTG9nTGlzdGVuZXIobGlzdGVuZXIsIHN1YnNjcmliZXJJZCwgc3RhcnRUaW1lLCBzdHJhdGVneUlkLCBwb3NpdGlvbklkLCBsZXZlbCwgbGltaXQpIHtcbiAgICBjb25zdCBsaXN0ZW5lcklkID0gcmFuZG9tc3RyaW5nLmdlbmVyYXRlKDEwKTtcbiAgICB0aGlzLl9zdWJzY3JpYmVyTG9nTGlzdGVuZXJzW2xpc3RlbmVySWRdID0gbGlzdGVuZXI7XG4gICAgdGhpcy5fc3RhcnRTdWJzY3JpYmVyTG9nU3RyZWFtSm9iKFxuICAgICAgbGlzdGVuZXJJZCwgXG4gICAgICBsaXN0ZW5lciwgXG4gICAgICBzdWJzY3JpYmVySWQsIFxuICAgICAgc3RhcnRUaW1lLCBcbiAgICAgIHN0cmF0ZWd5SWQsIFxuICAgICAgcG9zaXRpb25JZCwgXG4gICAgICBsZXZlbCwgXG4gICAgICBsaW1pdFxuICAgICk7XG4gICAgcmV0dXJuIGxpc3RlbmVySWQ7XG4gIH1cblxuICAvKipcbiAgICogUmVtb3ZlcyBzdHJhdGVneSBsb2cgbGlzdGVuZXIgYnkgaWRcbiAgICogQHBhcmFtIHtTdHJpbmd9IGxpc3RlbmVySWQgbGlzdGVuZXIgaWQgXG4gICAqL1xuICByZW1vdmVTdHJhdGVneUxvZ0xpc3RlbmVyKGxpc3RlbmVySWQpIHtcbiAgICBkZWxldGUgdGhpcy5fc3RyYXRlZ3lMb2dMaXN0ZW5lcnNbbGlzdGVuZXJJZF07XG4gIH1cblxuICAvKipcbiAgICogUmVtb3ZlcyBzdWJzY3JpYmVyIGxvZyBsaXN0ZW5lciBieSBpZFxuICAgKiBAcGFyYW0ge1N0cmluZ30gbGlzdGVuZXJJZCBsaXN0ZW5lciBpZCBcbiAgICovXG4gIHJlbW92ZVN1YnNjcmliZXJMb2dMaXN0ZW5lcihsaXN0ZW5lcklkKSB7XG4gICAgZGVsZXRlIHRoaXMuX3N1YnNjcmliZXJMb2dMaXN0ZW5lcnNbbGlzdGVuZXJJZF07XG4gIH1cblxuICBhc3luYyBfc3RhcnRTdHJhdGVneUxvZ1N0cmVhbUpvYihsaXN0ZW5lcklkLCBsaXN0ZW5lciwgc3RyYXRlZ3lJZCwgc3RhcnRUaW1lLCBwb3NpdGlvbklkLCBsZXZlbCwgbGltaXQpIHtcbiAgICBsZXQgdGhyb3R0bGVUaW1lID0gdGhpcy5fZXJyb3JUaHJvdHRsZVRpbWU7XG5cbiAgICB3aGlsZSh0aGlzLl9zdHJhdGVneUxvZ0xpc3RlbmVyc1tsaXN0ZW5lcklkXSkge1xuICAgICAgY29uc3Qgb3B0cyA9IHtcbiAgICAgICAgdXJsOiBgL3VzZXJzL2N1cnJlbnQvc3RyYXRlZ2llcy8ke3N0cmF0ZWd5SWR9L3VzZXItbG9nL3N0cmVhbWAsXG4gICAgICAgIG1ldGhvZDogJ0dFVCcsXG4gICAgICAgIHBhcmFtczoge1xuICAgICAgICAgIHN0YXJ0VGltZSxcbiAgICAgICAgICBwb3NpdGlvbklkLFxuICAgICAgICAgIGxldmVsLFxuICAgICAgICAgIGxpbWl0XG4gICAgICAgIH0sXG4gICAgICAgIGhlYWRlcnM6IHtcbiAgICAgICAgICAnYXV0aC10b2tlbic6IHRoaXMuX3Rva2VuXG4gICAgICAgIH0sXG4gICAgICAgIGpzb246IHRydWVcbiAgICAgIH07XG4gICAgICB0cnkge1xuICAgICAgICBjb25zdCBwYWNrZXRzID0gYXdhaXQgdGhpcy5fZG9tYWluQ2xpZW50LnJlcXVlc3RDb3B5RmFjdG9yeShvcHRzLCB0cnVlKTtcbiAgICAgICAgLy8gc3RvcCBqb2IgaWYgdXNlciBoYXMgdW5zdWJzY3JpYmVkIGluIHRpbWUgb2YgbmV3IHBhY2tldHMgaGFzIGJlZW4gcmVjZWl2ZWRcbiAgICAgICAgaWYgKCF0aGlzLl9zdHJhdGVneUxvZ0xpc3RlbmVyc1tsaXN0ZW5lcklkXSkgeyByZXR1cm47IH1cbiAgICAgICAgYXdhaXQgbGlzdGVuZXIub25Vc2VyTG9nKHBhY2tldHMpO1xuICAgICAgICB0aHJvdHRsZVRpbWUgPSB0aGlzLl9lcnJvclRocm90dGxlVGltZTtcbiAgICAgICAgaWYodGhpcy5fc3RyYXRlZ3lMb2dMaXN0ZW5lcnNbbGlzdGVuZXJJZF0gJiYgcGFja2V0cy5sZW5ndGgpIHtcbiAgICAgICAgICBzdGFydFRpbWUgPSBuZXcgRGF0ZShuZXcgRGF0ZShwYWNrZXRzWzBdLnRpbWUpLmdldFRpbWUoKSArIDEpO1xuICAgICAgICB9XG4gICAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgICAgYXdhaXQgbGlzdGVuZXIub25FcnJvcihlcnIpO1xuICAgICAgICBpZiAoZXJyLm5hbWUgPT09ICdOb3RGb3VuZEVycm9yJykge1xuICAgICAgICAgIHRoaXMuX2xvZ2dlci5lcnJvcihgU3RyYXRlZ3kgJHtzdHJhdGVneUlkfSBub3QgZm91bmQsIHJlbW92aW5nIGxpc3RlbmVyICR7bGlzdGVuZXJJZH1gKTtcbiAgICAgICAgICBkZWxldGUgdGhpcy5fc3RyYXRlZ3lMb2dMaXN0ZW5lcnNbbGlzdGVuZXJJZF07IFxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHRoaXMuX2xvZ2dlci5lcnJvcihgRmFpbGVkIHRvIHJldHJpZXZlIHVzZXIgbG9nIHN0cmVhbSBmb3Igc3RyYXRlZ3kgJHtzdHJhdGVneUlkfSwgYCArXG4gICAgICAgICAgICBgbGlzdGVuZXIgJHtsaXN0ZW5lcklkfSwgcmV0cnlpbmcgaW4gJHtNYXRoLmZsb29yKHRocm90dGxlVGltZS8xMDAwKX0gc2Vjb25kc2AsIGVycik7XG4gICAgICAgICAgYXdhaXQgbmV3IFByb21pc2UocmVzID0+IHNldFRpbWVvdXQocmVzLCB0aHJvdHRsZVRpbWUpKTtcbiAgICAgICAgICB0aHJvdHRsZVRpbWUgPSBNYXRoLm1pbih0aHJvdHRsZVRpbWUgKiAyLCAzMDAwMCk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBhc3luYyBfc3RhcnRTdWJzY3JpYmVyTG9nU3RyZWFtSm9iKFxuICAgIGxpc3RlbmVySWQsIFxuICAgIGxpc3RlbmVyLCBcbiAgICBzdWJzY3JpYmVySWQsIFxuICAgIHN0YXJ0VGltZSwgXG4gICAgc3RyYXRlZ3lJZCwgXG4gICAgcG9zaXRpb25JZCwgXG4gICAgbGV2ZWwsIFxuICAgIGxpbWl0XG4gICkge1xuICAgIGxldCB0aHJvdHRsZVRpbWUgPSB0aGlzLl9lcnJvclRocm90dGxlVGltZTtcblxuICAgIHdoaWxlKHRoaXMuX3N1YnNjcmliZXJMb2dMaXN0ZW5lcnNbbGlzdGVuZXJJZF0pIHtcbiAgICAgIGNvbnN0IG9wdHMgPSB7XG4gICAgICAgIHVybDogYC91c2Vycy9jdXJyZW50L3N1YnNjcmliZXJzLyR7c3Vic2NyaWJlcklkfS91c2VyLWxvZy9zdHJlYW1gLFxuICAgICAgICBtZXRob2Q6ICdHRVQnLFxuICAgICAgICBwYXJhbXM6IHtcbiAgICAgICAgICBzdGFydFRpbWUsXG4gICAgICAgICAgc3RyYXRlZ3lJZCxcbiAgICAgICAgICBwb3NpdGlvbklkLFxuICAgICAgICAgIGxldmVsLFxuICAgICAgICAgIGxpbWl0XG4gICAgICAgIH0sXG4gICAgICAgIGhlYWRlcnM6IHtcbiAgICAgICAgICAnYXV0aC10b2tlbic6IHRoaXMuX3Rva2VuXG4gICAgICAgIH0sXG4gICAgICAgIGpzb246IHRydWVcbiAgICAgIH07XG4gICAgICB0cnkge1xuICAgICAgICBjb25zdCBwYWNrZXRzID0gYXdhaXQgdGhpcy5fZG9tYWluQ2xpZW50LnJlcXVlc3RDb3B5RmFjdG9yeShvcHRzLCB0cnVlKTtcbiAgICAgICAgLy8gc3RvcCBqb2IgaWYgdXNlciBoYXMgdW5zdWJzY3JpYmVkIGluIHRpbWUgb2YgbmV3IHBhY2tldHMgaGFzIGJlZW4gcmVjZWl2ZWRcbiAgICAgICAgaWYgKCF0aGlzLl9zdWJzY3JpYmVyTG9nTGlzdGVuZXJzW2xpc3RlbmVySWRdKSB7IHJldHVybjsgfVxuICAgICAgICBhd2FpdCBsaXN0ZW5lci5vblVzZXJMb2cocGFja2V0cyk7XG4gICAgICAgIHRocm90dGxlVGltZSA9IHRoaXMuX2Vycm9yVGhyb3R0bGVUaW1lO1xuICAgICAgICBpZih0aGlzLl9zdWJzY3JpYmVyTG9nTGlzdGVuZXJzW2xpc3RlbmVySWRdICYmIHBhY2tldHMubGVuZ3RoKSB7XG4gICAgICAgICAgc3RhcnRUaW1lID0gbmV3IERhdGUobmV3IERhdGUocGFja2V0c1swXS50aW1lKS5nZXRUaW1lKCkgKyAxKTtcbiAgICAgICAgfVxuICAgICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAgIGF3YWl0IGxpc3RlbmVyLm9uRXJyb3IoZXJyKTtcbiAgICAgICAgaWYgKGVyci5uYW1lID09PSAnTm90Rm91bmRFcnJvcicpIHtcbiAgICAgICAgICB0aGlzLl9sb2dnZXIuZXJyb3IoYFN1YnNjcmliZXIgJHtzdWJzY3JpYmVySWR9IG5vdCBmb3VuZCwgcmVtb3ZpbmcgbGlzdGVuZXIgJHtsaXN0ZW5lcklkfWApO1xuICAgICAgICAgIGRlbGV0ZSB0aGlzLl9zdWJzY3JpYmVyTG9nTGlzdGVuZXJzW2xpc3RlbmVySWRdOyBcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICB0aGlzLl9sb2dnZXIuZXJyb3IoYEZhaWxlZCB0byByZXRyaWV2ZSB1c2VyIGxvZyBzdHJlYW0gZm9yIHN1YnNjcmliZXIgJHtzdWJzY3JpYmVySWR9LCBgICtcbiAgICAgICAgICAgIGBsaXN0ZW5lciAke2xpc3RlbmVySWR9LCByZXRyeWluZyBpbiAke01hdGguZmxvb3IodGhyb3R0bGVUaW1lLzEwMDApfSBzZWNvbmRzYCwgZXJyKTtcbiAgICAgICAgICBhd2FpdCBuZXcgUHJvbWlzZShyZXMgPT4gc2V0VGltZW91dChyZXMsIHRocm90dGxlVGltZSkpO1xuICAgICAgICAgIHRocm90dGxlVGltZSA9IE1hdGgubWluKHRocm90dGxlVGltZSAqIDIsIDMwMDAwKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgfVxuXG59XG4iXSwibmFtZXMiOlsiVXNlckxvZ0xpc3RlbmVyTWFuYWdlciIsIk1ldGFBcGlDbGllbnQiLCJzdHJhdGVneUxvZ0xpc3RlbmVycyIsIl9zdHJhdGVneUxvZ0xpc3RlbmVycyIsInN1YnNjcmliZXJMb2dMaXN0ZW5lcnMiLCJfc3Vic2NyaWJlckxvZ0xpc3RlbmVycyIsImFkZFN0cmF0ZWd5TG9nTGlzdGVuZXIiLCJsaXN0ZW5lciIsInN0cmF0ZWd5SWQiLCJzdGFydFRpbWUiLCJwb3NpdGlvbklkIiwibGV2ZWwiLCJsaW1pdCIsImxpc3RlbmVySWQiLCJyYW5kb21zdHJpbmciLCJnZW5lcmF0ZSIsIl9zdGFydFN0cmF0ZWd5TG9nU3RyZWFtSm9iIiwiYWRkU3Vic2NyaWJlckxvZ0xpc3RlbmVyIiwic3Vic2NyaWJlcklkIiwiX3N0YXJ0U3Vic2NyaWJlckxvZ1N0cmVhbUpvYiIsInJlbW92ZVN0cmF0ZWd5TG9nTGlzdGVuZXIiLCJyZW1vdmVTdWJzY3JpYmVyTG9nTGlzdGVuZXIiLCJ0aHJvdHRsZVRpbWUiLCJfZXJyb3JUaHJvdHRsZVRpbWUiLCJvcHRzIiwidXJsIiwibWV0aG9kIiwicGFyYW1zIiwiaGVhZGVycyIsIl90b2tlbiIsImpzb24iLCJwYWNrZXRzIiwiX2RvbWFpbkNsaWVudCIsInJlcXVlc3RDb3B5RmFjdG9yeSIsIm9uVXNlckxvZyIsImxlbmd0aCIsIkRhdGUiLCJ0aW1lIiwiZ2V0VGltZSIsImVyciIsIm9uRXJyb3IiLCJuYW1lIiwiX2xvZ2dlciIsImVycm9yIiwiTWF0aCIsImZsb29yIiwiUHJvbWlzZSIsInJlcyIsInNldFRpbWVvdXQiLCJtaW4iLCJjb25zdHJ1Y3RvciIsImRvbWFpbkNsaWVudCIsIkxvZ2dlck1hbmFnZXIiLCJnZXRMb2dnZXIiXSwibWFwcGluZ3MiOiJBQUFBOzs7Ozs7O2VBU3FCQTs7O3NFQVBLO3FFQUNEOytEQUNDOzs7Ozs7QUFLWCxJQUFBLEFBQU1BLHlCQUFOLE1BQU1BLCtCQUErQkMsc0JBQWE7SUFlL0Q7OztHQUdDLEdBQ0QsSUFBSUMsdUJBQXVCO1FBQ3pCLE9BQU8sSUFBSSxDQUFDQyxxQkFBcUI7SUFDbkM7SUFFQTs7O0dBR0MsR0FDRCxJQUFJQyx5QkFBeUI7UUFDM0IsT0FBTyxJQUFJLENBQUNDLHVCQUF1QjtJQUNyQztJQUVBOzs7Ozs7Ozs7R0FTQyxHQUNEQyx1QkFBdUJDLFFBQVEsRUFBRUMsVUFBVSxFQUFFQyxTQUFTLEVBQUVDLFVBQVUsRUFBRUMsS0FBSyxFQUFFQyxLQUFLLEVBQUU7UUFDaEYsTUFBTUMsYUFBYUMscUJBQVksQ0FBQ0MsUUFBUSxDQUFDO1FBQ3pDLElBQUksQ0FBQ1oscUJBQXFCLENBQUNVLFdBQVcsR0FBR047UUFDekMsSUFBSSxDQUFDUywwQkFBMEIsQ0FBQ0gsWUFBWU4sVUFBVUMsWUFBWUMsV0FBV0MsWUFBWUMsT0FBT0M7UUFDaEcsT0FBT0M7SUFDVDtJQUVBOzs7Ozs7Ozs7O0dBVUMsR0FDREkseUJBQXlCVixRQUFRLEVBQUVXLFlBQVksRUFBRVQsU0FBUyxFQUFFRCxV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