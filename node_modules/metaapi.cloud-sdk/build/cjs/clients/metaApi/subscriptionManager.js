"use strict";
Object.defineProperty(exports, "__esModule", {
    value: true
});
Object.defineProperty(exports, "default", {
    enumerable: true,
    get: function() {
        return SubscriptionManager;
    }
});
const _logger = /*#__PURE__*/ _interop_require_default(require("../../logger"));
function _interop_require_default(obj) {
    return obj && obj.__esModule ? obj : {
        default: obj
    };
}
let SubscriptionManager = class SubscriptionManager {
    /**
   * Returns whether an account is currently subscribing
   * @param {String} accountId account id
   * @param {Number} instanceNumber instance index number
   * @returns {Boolean} whether an account is currently subscribing
   */ isAccountSubscribing(accountId, instanceNumber) {
        if (instanceNumber !== undefined) {
            return Object.keys(this._subscriptions).includes(accountId + ":" + instanceNumber);
        } else {
            for (let key of Object.keys(this._subscriptions)){
                if (key.startsWith(accountId)) {
                    return true;
                }
            }
            return false;
        }
    }
    /**
   * Returns whether an instance is in disconnected retry mode
   * @param {String} accountId account id
   * @param {Number} instanceNumber instance index number
   * @returns {Boolean} whether an account is currently subscribing
   */ isDisconnectedRetryMode(accountId, instanceNumber) {
        let instanceId = accountId + ":" + (instanceNumber || 0);
        return this._subscriptions[instanceId] ? this._subscriptions[instanceId].isDisconnectedRetryMode : false;
    }
    /**
   * Returns whether an account subscription is active
   * @param {String} accountId account id
   * @returns {Boolean} instance actual subscribe state
   */ isSubscriptionActive(accountId) {
        return !!this._subscriptionState[accountId];
    }
    /**
   * Subscribes to the Metatrader terminal events
   * @param {String} accountId id of the MetaTrader account to subscribe to
   * @param {Number} instanceNumber instance index number
   * @returns {Promise} promise which resolves when subscription started
   */ subscribe(accountId, instanceNumber) {
        this._subscriptionState[accountId] = true;
        return this._websocketClient.rpcRequest(accountId, {
            type: "subscribe",
            instanceIndex: instanceNumber
        });
    }
    /**
   * Schedules to send subscribe requests to an account until cancelled
   * @param {String} accountId id of the MetaTrader account
   * @param {Number} instanceNumber instance index number
   * @param {Boolean} isDisconnectedRetryMode whether to start subscription in disconnected retry
   * mode. Subscription task in disconnected mode will be immediately replaced when the status packet is received
   */ async scheduleSubscribe(accountId, instanceNumber, isDisconnectedRetryMode = false) {
        const client = this._websocketClient;
        let instanceId = accountId + ":" + (instanceNumber || 0);
        if (!this._subscriptions[instanceId]) {
            this._subscriptions[instanceId] = {
                shouldRetry: true,
                task: null,
                waitTask: null,
                future: null,
                isDisconnectedRetryMode
            };
            let subscribeRetryIntervalInSeconds = 3;
            while(this._subscriptions[instanceId].shouldRetry){
                let resolveSubscribe;
                this._subscriptions[instanceId].task = {
                    promise: new Promise((res)=>{
                        resolveSubscribe = res;
                    })
                };
                this._subscriptions[instanceId].task.resolve = resolveSubscribe;
                // eslint-disable-next-line no-inner-declarations, complexity
                let subscribeTask = async ()=>{
                    try {
                        await this.subscribe(accountId, instanceNumber);
                    } catch (err) {
                        if (err.name === "TooManyRequestsError") {
                            const socketInstanceIndex = client.socketInstancesByAccounts[instanceNumber][accountId];
                            if (err.metadata.type === "LIMIT_ACCOUNT_SUBSCRIPTIONS_PER_USER") {
                                this._logger.error(`${instanceId}: Failed to subscribe`, err);
                            }
                            if ([
                                "LIMIT_ACCOUNT_SUBSCRIPTIONS_PER_USER",
                                "LIMIT_ACCOUNT_SUBSCRIPTIONS_PER_SERVER",
                                "LIMIT_ACCOUNT_SUBSCRIPTIONS_PER_USER_PER_SERVER"
                            ].includes(err.metadata.type)) {
                                delete client.socketInstancesByAccounts[instanceNumber][accountId];
                                client.lockSocketInstance(instanceNumber, socketInstanceIndex, this._websocketClient.getAccountRegion(accountId), err.metadata);
                            } else {
                                const retryTime = new Date(err.metadata.recommendedRetryTime).getTime();
                                if (Date.now() + subscribeRetryIntervalInSeconds * 1000 < retryTime) {
                                    await new Promise((res)=>setTimeout(res, retryTime - Date.now() - subscribeRetryIntervalInSeconds * 1000));
                                }
                            }
                        } else {
                            this._logger.error(`${instanceId}: Failed to subscribe`, err);
                            if (err.name === "NotFoundError") {
                                this.refreshAccount(accountId);
                            }
                            if (err.name === "TimeoutError") {
                                const mainAccountId = this._websocketClient.accountsByReplicaId[accountId];
                                if (mainAccountId) {
                                    const region = this._websocketClient.getAccountRegion(accountId);
                                    const connectedInstances = this._websocketClient._latencyService.getActiveAccountInstances(mainAccountId);
                                    // eslint-disable-next-line max-depth
                                    if (!connectedInstances.some((instance)=>instance.startsWith(`${mainAccountId}:${region}`))) {
                                        this._timeoutErrorCounter[accountId] = this._timeoutErrorCounter[accountId] || 0;
                                        this._timeoutErrorCounter[accountId]++;
                                        // eslint-disable-next-line max-depth
                                        if (this._timeoutErrorCounter[accountId] > 4) {
                                            this._timeoutErrorCounter[accountId] = 0;
                                            this.refreshAccount(accountId);
                                        }
                                    }
                                }
                            }
                        }
                    }
                    resolveSubscribe();
                };
                subscribeTask();
                await this._subscriptions[instanceId].task.promise;
                if (!this._subscriptions[instanceId].shouldRetry) {
                    break;
                }
                const retryInterval = subscribeRetryIntervalInSeconds;
                subscribeRetryIntervalInSeconds = Math.min(subscribeRetryIntervalInSeconds * 2, 300);
                let resolve;
                let subscribePromise = new Promise((res)=>{
                    resolve = res;
                });
                this._subscriptions[instanceId].waitTask = setTimeout(()=>{
                    resolve(true);
                }, retryInterval * 1000);
                this._subscriptions[instanceId].future = {
                    resolve,
                    promise: subscribePromise
                };
                const result = await this._subscriptions[instanceId].future.promise;
                this._subscriptions[instanceId].future = null;
                if (!result) {
                    break;
                }
            }
            delete this._subscriptions[instanceId];
        }
    }
    /**
   * Unsubscribe from account
   * @param {String} accountId id of the MetaTrader account to unsubscribe
   * @param {Number} instanceNumber instance index number
   * @returns {Promise} promise which resolves when socket unsubscribed
   */ async unsubscribe(accountId, instanceNumber) {
        this.cancelAccount(accountId);
        delete this._subscriptionState[accountId];
        return this._websocketClient.rpcRequest(accountId, {
            type: "unsubscribe",
            instanceIndex: instanceNumber
        });
    }
    /**
   * Cancels active subscription tasks for an instance id
   * @param {String} instanceId instance id to cancel subscription task for
   */ cancelSubscribe(instanceId) {
        if (this._subscriptions[instanceId]) {
            const subscription = this._subscriptions[instanceId];
            if (subscription.future) {
                subscription.future.resolve(false);
                clearTimeout(subscription.waitTask);
            }
            if (subscription.task) {
                subscription.task.resolve(false);
            }
            subscription.shouldRetry = false;
        }
    }
    /**
   * Cancels active subscription tasks for an account
   * @param {String} accountId account id to cancel subscription tasks for
   */ cancelAccount(accountId) {
        for (let instanceId of Object.keys(this._subscriptions).filter((key)=>key.startsWith(accountId))){
            this.cancelSubscribe(instanceId);
        }
        Object.keys(this._awaitingResubscribe).forEach((instanceNumber)=>delete this._awaitingResubscribe[instanceNumber][accountId]);
        delete this._timeoutErrorCounter[accountId];
    }
    /**
   * Invoked on account timeout.
   * @param {String} accountId id of the MetaTrader account
   * @param {Number} instanceNumber instance index number
   */ onTimeout(accountId, instanceNumber) {
        const region = this._websocketClient.getAccountRegion(accountId);
        if (this._websocketClient.socketInstancesByAccounts[instanceNumber][accountId] !== undefined && this._websocketClient.connected(instanceNumber, this._websocketClient.socketInstancesByAccounts[instanceNumber][accountId], region)) {
            this._logger.debug(`${accountId}:${instanceNumber}: scheduling subscribe because of account timeout`);
            this.scheduleSubscribe(accountId, instanceNumber, true);
        }
    }
    /**
   * Invoked when connection to MetaTrader terminal terminated
   * @param {String} accountId id of the MetaTrader account
   * @param {Number} instanceNumber instance index number
   */ async onDisconnected(accountId, instanceNumber) {
        await new Promise((res)=>setTimeout(res, Math.max(Math.random() * 5, 1) * 1000));
        if (this._websocketClient.socketInstancesByAccounts[instanceNumber][accountId] !== undefined) {
            this._logger.debug(`${accountId}:${instanceNumber}: scheduling subscribe because account disconnected`);
            this.scheduleSubscribe(accountId, instanceNumber, true);
        }
    }
    /**
   * Invoked when connection to MetaApi websocket API restored after a disconnect.
   * @param {Number} instanceNumber instance index number
   * @param {Number} socketInstanceIndex socket instance index
   * @param {String[]} reconnectAccountIds account ids to reconnect
   */ onReconnected(instanceNumber, socketInstanceIndex, reconnectAccountIds) {
        if (!this._awaitingResubscribe[instanceNumber]) {
            this._awaitingResubscribe[instanceNumber] = {};
        }
        try {
            const socketInstancesByAccounts = this._websocketClient.socketInstancesByAccounts[instanceNumber];
            for (let instanceId of Object.keys(this._subscriptions)){
                const accountId = instanceId.split(":")[0];
                if (socketInstancesByAccounts[accountId] === socketInstanceIndex) {
                    this.cancelSubscribe(instanceId);
                }
            }
            reconnectAccountIds.forEach(async (accountId)=>{
                try {
                    if (!this._awaitingResubscribe[instanceNumber][accountId]) {
                        this._awaitingResubscribe[instanceNumber][accountId] = true;
                        while(this.isAccountSubscribing(accountId, instanceNumber)){
                            await new Promise((res)=>setTimeout(res, 1000));
                        }
                        await new Promise((res)=>setTimeout(res, Math.random() * 5000));
                        if (this._awaitingResubscribe[instanceNumber][accountId]) {
                            delete this._awaitingResubscribe[instanceNumber][accountId];
                            this._logger.debug(`${accountId}:${instanceNumber}: scheduling subscribe because account reconnected`);
                            this.scheduleSubscribe(accountId, instanceNumber);
                        }
                    }
                } catch (err) {
                    this._logger.error(`${accountId}: Account resubscribe task failed`, err);
                }
            });
        } catch (err) {
            this._logger.error("Failed to process subscribe manager reconnected event", err);
        }
    }
    /**
   * Schedules a task to refresh the account data
   * @param {string} accountId account id
   */ refreshAccount(accountId) {
        const mainAccountId = this._websocketClient.accountsByReplicaId[accountId];
        if (mainAccountId) {
            const registry = this._metaApi._connectionRegistry;
            const rpcConnection = registry.rpcConnections[mainAccountId];
            const region = this._websocketClient.getAccountRegion(accountId);
            if (region) {
                if (rpcConnection) {
                    rpcConnection.scheduleRefresh(region);
                }
                const streamingConnection = registry.streamingConnections[mainAccountId];
                if (streamingConnection) {
                    streamingConnection.scheduleRefresh(region);
                }
            }
        }
    }
    /**
   * Constructs the subscription manager
   * @param {MetaApiWebsocketClient} websocketClient websocket client to use for sending requests
   * @param {MetaApi} metaApi metaApi instance
   */ constructor(websocketClient, metaApi){
        this._websocketClient = websocketClient;
        this._metaApi = metaApi;
        this._subscriptions = {};
        this._awaitingResubscribe = {};
        this._subscriptionState = {};
        this._logger = _logger.default.getLogger("SubscriptionManager");
        this._timeoutErrorCounter = {};
        this._recentlyDeletedAccounts = {};
    }
};

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIjxhbm9uPiJdLCJzb3VyY2VzQ29udGVudCI6WyIndXNlIHN0cmljdCc7XG5cbmltcG9ydCBMb2dnZXJNYW5hZ2VyIGZyb20gJy4uLy4uL2xvZ2dlcic7XG5cbi8qKlxuICogU3Vic2NyaXB0aW9uIG1hbmFnZXIgdG8gaGFuZGxlIGFjY291bnQgc3Vic2NyaXB0aW9uIGxvZ2ljXG4gKi9cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIFN1YnNjcmlwdGlvbk1hbmFnZXIge1xuXG4gIC8qKlxuICAgKiBDb25zdHJ1Y3RzIHRoZSBzdWJzY3JpcHRpb24gbWFuYWdlclxuICAgKiBAcGFyYW0ge01ldGFBcGlXZWJzb2NrZXRDbGllbnR9IHdlYnNvY2tldENsaWVudCB3ZWJzb2NrZXQgY2xpZW50IHRvIHVzZSBmb3Igc2VuZGluZyByZXF1ZXN0c1xuICAgKiBAcGFyYW0ge01ldGFBcGl9IG1ldGFBcGkgbWV0YUFwaSBpbnN0YW5jZVxuICAgKi9cbiAgY29uc3RydWN0b3Iod2Vic29ja2V0Q2xpZW50LCBtZXRhQXBpKSB7XG4gICAgdGhpcy5fd2Vic29ja2V0Q2xpZW50ID0gd2Vic29ja2V0Q2xpZW50O1xuICAgIHRoaXMuX21ldGFBcGkgPSBtZXRhQXBpO1xuICAgIHRoaXMuX3N1YnNjcmlwdGlvbnMgPSB7fTtcbiAgICB0aGlzLl9hd2FpdGluZ1Jlc3Vic2NyaWJlID0ge307XG4gICAgdGhpcy5fc3Vic2NyaXB0aW9uU3RhdGUgPSB7fTtcbiAgICB0aGlzLl9sb2dnZXIgPSBMb2dnZXJNYW5hZ2VyLmdldExvZ2dlcignU3Vic2NyaXB0aW9uTWFuYWdlcicpO1xuICAgIHRoaXMuX3RpbWVvdXRFcnJvckNvdW50ZXIgPSB7fTtcbiAgICB0aGlzLl9yZWNlbnRseURlbGV0ZWRBY2NvdW50cyA9IHt9O1xuICB9XG5cbiAgLyoqXG4gICAqIFJldHVybnMgd2hldGhlciBhbiBhY2NvdW50IGlzIGN1cnJlbnRseSBzdWJzY3JpYmluZ1xuICAgKiBAcGFyYW0ge1N0cmluZ30gYWNjb3VudElkIGFjY291bnQgaWRcbiAgICogQHBhcmFtIHtOdW1iZXJ9IGluc3RhbmNlTnVtYmVyIGluc3RhbmNlIGluZGV4IG51bWJlclxuICAgKiBAcmV0dXJucyB7Qm9vbGVhbn0gd2hldGhlciBhbiBhY2NvdW50IGlzIGN1cnJlbnRseSBzdWJzY3JpYmluZ1xuICAgKi9cbiAgaXNBY2NvdW50U3Vic2NyaWJpbmcoYWNjb3VudElkLCBpbnN0YW5jZU51bWJlcikge1xuICAgIGlmIChpbnN0YW5jZU51bWJlciAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICByZXR1cm4gT2JqZWN0LmtleXModGhpcy5fc3Vic2NyaXB0aW9ucykuaW5jbHVkZXMoYWNjb3VudElkICsgJzonICsgaW5zdGFuY2VOdW1iZXIpO1xuICAgIH0gZWxzZSB7XG4gICAgICBmb3IgKGxldCBrZXkgb2YgT2JqZWN0LmtleXModGhpcy5fc3Vic2NyaXB0aW9ucykpIHtcbiAgICAgICAgaWYgKGtleS5zdGFydHNXaXRoKGFjY291bnRJZCkpIHtcbiAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBSZXR1cm5zIHdoZXRoZXIgYW4gaW5zdGFuY2UgaXMgaW4gZGlzY29ubmVjdGVkIHJldHJ5IG1vZGVcbiAgICogQHBhcmFtIHtTdHJpbmd9IGFjY291bnRJZCBhY2NvdW50IGlkXG4gICAqIEBwYXJhbSB7TnVtYmVyfSBpbnN0YW5jZU51bWJlciBpbnN0YW5jZSBpbmRleCBudW1iZXJcbiAgICogQHJldHVybnMge0Jvb2xlYW59IHdoZXRoZXIgYW4gYWNjb3VudCBpcyBjdXJyZW50bHkgc3Vic2NyaWJpbmdcbiAgICovXG4gIGlzRGlzY29ubmVjdGVkUmV0cnlNb2RlKGFjY291bnRJZCwgaW5zdGFuY2VOdW1iZXIpIHtcbiAgICBsZXQgaW5zdGFuY2VJZCA9IGFjY291bnRJZCArICc6JyArIChpbnN0YW5jZU51bWJlciB8fCAwKTtcbiAgICByZXR1cm4gdGhpcy5fc3Vic2NyaXB0aW9uc1tpbnN0YW5jZUlkXSA/IHRoaXMuX3N1YnNjcmlwdGlvbnNbaW5zdGFuY2VJZF0uaXNEaXNjb25uZWN0ZWRSZXRyeU1vZGUgOiBmYWxzZTtcbiAgfVxuXG4gIC8qKlxuICAgKiBSZXR1cm5zIHdoZXRoZXIgYW4gYWNjb3VudCBzdWJzY3JpcHRpb24gaXMgYWN0aXZlXG4gICAqIEBwYXJhbSB7U3RyaW5nfSBhY2NvdW50SWQgYWNjb3VudCBpZFxuICAgKiBAcmV0dXJucyB7Qm9vbGVhbn0gaW5zdGFuY2UgYWN0dWFsIHN1YnNjcmliZSBzdGF0ZVxuICAgKi9cbiAgaXNTdWJzY3JpcHRpb25BY3RpdmUoYWNjb3VudElkKSB7XG4gICAgcmV0dXJuICEhdGhpcy5fc3Vic2NyaXB0aW9uU3RhdGVbYWNjb3VudElkXTtcbiAgfVxuXG4gIC8qKlxuICAgKiBTdWJzY3JpYmVzIHRvIHRoZSBNZXRhdHJhZGVyIHRlcm1pbmFsIGV2ZW50c1xuICAgKiBAcGFyYW0ge1N0cmluZ30gYWNjb3VudElkIGlkIG9mIHRoZSBNZXRhVHJhZGVyIGFjY291bnQgdG8gc3Vic2NyaWJlIHRvXG4gICAqIEBwYXJhbSB7TnVtYmVyfSBpbnN0YW5jZU51bWJlciBpbnN0YW5jZSBpbmRleCBudW1iZXJcbiAgICogQHJldHVybnMge1Byb21pc2V9IHByb21pc2Ugd2hpY2ggcmVzb2x2ZXMgd2hlbiBzdWJzY3JpcHRpb24gc3RhcnRlZFxuICAgKi9cbiAgc3Vic2NyaWJlKGFjY291bnRJZCwgaW5zdGFuY2VOdW1iZXIpIHtcbiAgICB0aGlzLl9zdWJzY3JpcHRpb25TdGF0ZVthY2NvdW50SWRdID0gdHJ1ZTtcbiAgICByZXR1cm4gdGhpcy5fd2Vic29ja2V0Q2xpZW50LnJwY1JlcXVlc3QoYWNjb3VudElkLCB7dHlwZTogJ3N1YnNjcmliZScsIGluc3RhbmNlSW5kZXg6IGluc3RhbmNlTnVtYmVyfSk7XG4gIH1cblxuICAvKipcbiAgICogU2NoZWR1bGVzIHRvIHNlbmQgc3Vic2NyaWJlIHJlcXVlc3RzIHRvIGFuIGFjY291bnQgdW50aWwgY2FuY2VsbGVkXG4gICAqIEBwYXJhbSB7U3RyaW5nfSBhY2NvdW50SWQgaWQgb2YgdGhlIE1ldGFUcmFkZXIgYWNjb3VudFxuICAgKiBAcGFyYW0ge051bWJlcn0gaW5zdGFuY2VOdW1iZXIgaW5zdGFuY2UgaW5kZXggbnVtYmVyXG4gICAqIEBwYXJhbSB7Qm9vbGVhbn0gaXNEaXNjb25uZWN0ZWRSZXRyeU1vZGUgd2hldGhlciB0byBzdGFydCBzdWJzY3JpcHRpb24gaW4gZGlzY29ubmVjdGVkIHJldHJ5XG4gICAqIG1vZGUuIFN1YnNjcmlwdGlvbiB0YXNrIGluIGRpc2Nvbm5lY3RlZCBtb2RlIHdpbGwgYmUgaW1tZWRpYXRlbHkgcmVwbGFjZWQgd2hlbiB0aGUgc3RhdHVzIHBhY2tldCBpcyByZWNlaXZlZFxuICAgKi9cbiAgYXN5bmMgc2NoZWR1bGVTdWJzY3JpYmUoYWNjb3VudElkLCBpbnN0YW5jZU51bWJlciwgaXNEaXNjb25uZWN0ZWRSZXRyeU1vZGUgPSBmYWxzZSkge1xuICAgIGNvbnN0IGNsaWVudCA9IHRoaXMuX3dlYnNvY2tldENsaWVudDtcbiAgICBsZXQgaW5zdGFuY2VJZCA9IGFjY291bnRJZCArICc6JyArIChpbnN0YW5jZU51bWJlciB8fCAwKTtcbiAgICBpZiAoIXRoaXMuX3N1YnNjcmlwdGlvbnNbaW5zdGFuY2VJZF0pIHtcbiAgICAgIHRoaXMuX3N1YnNjcmlwdGlvbnNbaW5zdGFuY2VJZF0gPSB7XG4gICAgICAgIHNob3VsZFJldHJ5OiB0cnVlLFxuICAgICAgICB0YXNrOiBudWxsLFxuICAgICAgICB3YWl0VGFzazogbnVsbCxcbiAgICAgICAgZnV0dXJlOiBudWxsLFxuICAgICAgICBpc0Rpc2Nvbm5lY3RlZFJldHJ5TW9kZVxuICAgICAgfTtcbiAgICAgIGxldCBzdWJzY3JpYmVSZXRyeUludGVydmFsSW5TZWNvbmRzID0gMztcbiAgICAgIHdoaWxlICh0aGlzLl9zdWJzY3JpcHRpb25zW2luc3RhbmNlSWRdLnNob3VsZFJldHJ5KSB7XG4gICAgICAgIGxldCByZXNvbHZlU3Vic2NyaWJlO1xuICAgICAgICB0aGlzLl9zdWJzY3JpcHRpb25zW2luc3RhbmNlSWRdLnRhc2sgPSB7cHJvbWlzZTogbmV3IFByb21pc2UoKHJlcykgPT4ge1xuICAgICAgICAgIHJlc29sdmVTdWJzY3JpYmUgPSByZXM7XG4gICAgICAgIH0pfTtcbiAgICAgICAgdGhpcy5fc3Vic2NyaXB0aW9uc1tpbnN0YW5jZUlkXS50YXNrLnJlc29sdmUgPSByZXNvbHZlU3Vic2NyaWJlO1xuICAgICAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgbm8taW5uZXItZGVjbGFyYXRpb25zLCBjb21wbGV4aXR5XG4gICAgICAgIGxldCBzdWJzY3JpYmVUYXNrID0gYXN5bmMgKCkgPT4ge1xuICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICBhd2FpdCB0aGlzLnN1YnNjcmliZShhY2NvdW50SWQsIGluc3RhbmNlTnVtYmVyKTtcbiAgICAgICAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgICAgICAgIGlmIChlcnIubmFtZSA9PT0gJ1Rvb01hbnlSZXF1ZXN0c0Vycm9yJykge1xuICAgICAgICAgICAgICBjb25zdCBzb2NrZXRJbnN0YW5jZUluZGV4ID0gY2xpZW50LnNvY2tldEluc3RhbmNlc0J5QWNjb3VudHNbaW5zdGFuY2VOdW1iZXJdW2FjY291bnRJZF07XG4gICAgICAgICAgICAgIGlmIChlcnIubWV0YWRhdGEudHlwZSA9PT0gJ0xJTUlUX0FDQ09VTlRfU1VCU0NSSVBUSU9OU19QRVJfVVNFUicpIHtcbiAgICAgICAgICAgICAgICB0aGlzLl9sb2dnZXIuZXJyb3IoYCR7aW5zdGFuY2VJZH06IEZhaWxlZCB0byBzdWJzY3JpYmVgLCBlcnIpO1xuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgIGlmIChbJ0xJTUlUX0FDQ09VTlRfU1VCU0NSSVBUSU9OU19QRVJfVVNFUicsICdMSU1JVF9BQ0NPVU5UX1NVQlNDUklQVElPTlNfUEVSX1NFUlZFUicsIFxuICAgICAgICAgICAgICAgICdMSU1JVF9BQ0NPVU5UX1NVQlNDUklQVElPTlNfUEVSX1VTRVJfUEVSX1NFUlZFUiddLmluY2x1ZGVzKGVyci5tZXRhZGF0YS50eXBlKSkge1xuICAgICAgICAgICAgICAgIGRlbGV0ZSBjbGllbnQuc29ja2V0SW5zdGFuY2VzQnlBY2NvdW50c1tpbnN0YW5jZU51bWJlcl1bYWNjb3VudElkXTtcbiAgICAgICAgICAgICAgICBjbGllbnQubG9ja1NvY2tldEluc3RhbmNlKGluc3RhbmNlTnVtYmVyLCBzb2NrZXRJbnN0YW5jZUluZGV4LCBcbiAgICAgICAgICAgICAgICAgIHRoaXMuX3dlYnNvY2tldENsaWVudC5nZXRBY2NvdW50UmVnaW9uKGFjY291bnRJZCksIGVyci5tZXRhZGF0YSk7XG4gICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgY29uc3QgcmV0cnlUaW1lID0gbmV3IERhdGUoZXJyLm1ldGFkYXRhLnJlY29tbWVuZGVkUmV0cnlUaW1lKS5nZXRUaW1lKCk7XG4gICAgICAgICAgICAgICAgaWYgKERhdGUubm93KCkgKyBzdWJzY3JpYmVSZXRyeUludGVydmFsSW5TZWNvbmRzICogMTAwMCA8IHJldHJ5VGltZSkge1xuICAgICAgICAgICAgICAgICAgYXdhaXQgbmV3IFByb21pc2UocmVzID0+IHNldFRpbWVvdXQocmVzLCByZXRyeVRpbWUgLSBEYXRlLm5vdygpIC1cbiAgICAgICAgICAgICAgICAgICAgc3Vic2NyaWJlUmV0cnlJbnRlcnZhbEluU2Vjb25kcyAqIDEwMDApKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgIHRoaXMuX2xvZ2dlci5lcnJvcihgJHtpbnN0YW5jZUlkfTogRmFpbGVkIHRvIHN1YnNjcmliZWAsIGVycik7XG4gICAgICAgICAgICAgIGlmIChlcnIubmFtZSA9PT0gJ05vdEZvdW5kRXJyb3InKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5yZWZyZXNoQWNjb3VudChhY2NvdW50SWQpO1xuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgIGlmIChlcnIubmFtZSA9PT0gJ1RpbWVvdXRFcnJvcicpIHtcbiAgICAgICAgICAgICAgICBjb25zdCBtYWluQWNjb3VudElkID0gdGhpcy5fd2Vic29ja2V0Q2xpZW50LmFjY291bnRzQnlSZXBsaWNhSWRbYWNjb3VudElkXTtcbiAgICAgICAgICAgICAgICBpZiAobWFpbkFjY291bnRJZCkge1xuICAgICAgICAgICAgICAgICAgY29uc3QgcmVnaW9uID0gdGhpcy5fd2Vic29ja2V0Q2xpZW50LmdldEFjY291bnRSZWdpb24oYWNjb3VudElkKTtcbiAgICAgICAgICAgICAgICAgIGNvbnN0IGNvbm5lY3RlZEluc3RhbmNlcyA9IFxuICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX3dlYnNvY2tldENsaWVudC5fbGF0ZW5jeVNlcnZpY2UuZ2V0QWN0aXZlQWNjb3VudEluc3RhbmNlcyhtYWluQWNjb3VudElkKTtcbiAgICAgICAgICAgICAgICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBtYXgtZGVwdGhcbiAgICAgICAgICAgICAgICAgIGlmICghY29ubmVjdGVkSW5zdGFuY2VzLnNvbWUoaW5zdGFuY2UgPT4gaW5zdGFuY2Uuc3RhcnRzV2l0aChgJHttYWluQWNjb3VudElkfToke3JlZ2lvbn1gKSkpIHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5fdGltZW91dEVycm9yQ291bnRlclthY2NvdW50SWRdID0gdGhpcy5fdGltZW91dEVycm9yQ291bnRlclthY2NvdW50SWRdIHx8IDA7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuX3RpbWVvdXRFcnJvckNvdW50ZXJbYWNjb3VudElkXSsrO1xuICAgICAgICAgICAgICAgICAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgbWF4LWRlcHRoXG4gICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLl90aW1lb3V0RXJyb3JDb3VudGVyW2FjY291bnRJZF0gPiA0KSB7XG4gICAgICAgICAgICAgICAgICAgICAgdGhpcy5fdGltZW91dEVycm9yQ291bnRlclthY2NvdW50SWRdID0gMDtcbiAgICAgICAgICAgICAgICAgICAgICB0aGlzLnJlZnJlc2hBY2NvdW50KGFjY291bnRJZCk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9XG4gICAgICAgICAgcmVzb2x2ZVN1YnNjcmliZSgpO1xuICAgICAgICB9O1xuICAgICAgICBzdWJzY3JpYmVUYXNrKCk7XG4gICAgICAgIGF3YWl0IHRoaXMuX3N1YnNjcmlwdGlvbnNbaW5zdGFuY2VJZF0udGFzay5wcm9taXNlO1xuICAgICAgICBpZiAoIXRoaXMuX3N1YnNjcmlwdGlvbnNbaW5zdGFuY2VJZF0uc2hvdWxkUmV0cnkpIHtcbiAgICAgICAgICBicmVhaztcbiAgICAgICAgfVxuICAgICAgICBjb25zdCByZXRyeUludGVydmFsID0gc3Vic2NyaWJlUmV0cnlJbnRlcnZhbEluU2Vjb25kcztcbiAgICAgICAgc3Vic2NyaWJlUmV0cnlJbnRlcnZhbEluU2Vjb25kcyA9IE1hdGgubWluKHN1YnNjcmliZVJldHJ5SW50ZXJ2YWxJblNlY29uZHMgKiAyLCAzMDApO1xuICAgICAgICBsZXQgcmVzb2x2ZTtcbiAgICAgICAgbGV0IHN1YnNjcmliZVByb21pc2UgPSBuZXcgUHJvbWlzZSgocmVzKSA9PiB7XG4gICAgICAgICAgcmVzb2x2ZSA9IHJlcztcbiAgICAgICAgfSk7XG4gICAgICAgIHRoaXMuX3N1YnNjcmlwdGlvbnNbaW5zdGFuY2VJZF0ud2FpdFRhc2sgPSBzZXRUaW1lb3V0KCgpID0+IHtcbiAgICAgICAgICByZXNvbHZlKHRydWUpO1xuICAgICAgICB9LCByZXRyeUludGVydmFsICogMTAwMCk7XG4gICAgICAgIHRoaXMuX3N1YnNjcmlwdGlvbnNbaW5zdGFuY2VJZF0uZnV0dXJlID0ge3Jlc29sdmUsIHByb21pc2U6IHN1YnNjcmliZVByb21pc2V9O1xuICAgICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCB0aGlzLl9zdWJzY3JpcHRpb25zW2luc3RhbmNlSWRdLmZ1dHVyZS5wcm9taXNlO1xuICAgICAgICB0aGlzLl9zdWJzY3JpcHRpb25zW2luc3RhbmNlSWRdLmZ1dHVyZSA9IG51bGw7XG4gICAgICAgIGlmICghcmVzdWx0KSB7XG4gICAgICAgICAgYnJlYWs7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIGRlbGV0ZSB0aGlzLl9zdWJzY3JpcHRpb25zW2luc3RhbmNlSWRdO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBVbnN1YnNjcmliZSBmcm9tIGFjY291bnRcbiAgICogQHBhcmFtIHtTdHJpbmd9IGFjY291bnRJZCBpZCBvZiB0aGUgTWV0YVRyYWRlciBhY2NvdW50IHRvIHVuc3Vic2NyaWJlXG4gICAqIEBwYXJhbSB7TnVtYmVyfSBpbnN0YW5jZU51bWJlciBpbnN0YW5jZSBpbmRleCBudW1iZXJcbiAgICogQHJldHVybnMge1Byb21pc2V9IHByb21pc2Ugd2hpY2ggcmVzb2x2ZXMgd2hlbiBzb2NrZXQgdW5zdWJzY3JpYmVkXG4gICAqL1xuICBhc3luYyB1bnN1YnNjcmliZShhY2NvdW50SWQsIGluc3RhbmNlTnVtYmVyKSB7XG4gICAgdGhpcy5jYW5jZWxBY2NvdW50KGFjY291bnRJZCk7XG4gICAgZGVsZXRlIHRoaXMuX3N1YnNjcmlwdGlvblN0YXRlW2FjY291bnRJZF07XG4gICAgcmV0dXJuIHRoaXMuX3dlYnNvY2tldENsaWVudC5ycGNSZXF1ZXN0KGFjY291bnRJZCwge3R5cGU6ICd1bnN1YnNjcmliZScsIGluc3RhbmNlSW5kZXg6IGluc3RhbmNlTnVtYmVyfSk7XG4gIH1cblxuICAvKipcbiAgICogQ2FuY2VscyBhY3RpdmUgc3Vic2NyaXB0aW9uIHRhc2tzIGZvciBhbiBpbnN0YW5jZSBpZFxuICAgKiBAcGFyYW0ge1N0cmluZ30gaW5zdGFuY2VJZCBpbnN0YW5jZSBpZCB0byBjYW5jZWwgc3Vic2NyaXB0aW9uIHRhc2sgZm9yXG4gICAqL1xuICBjYW5jZWxTdWJzY3JpYmUoaW5zdGFuY2VJZCkge1xuICAgIGlmICh0aGlzLl9zdWJzY3JpcHRpb25zW2luc3RhbmNlSWRdKSB7XG4gICAgICBjb25zdCBzdWJzY3JpcHRpb24gPSB0aGlzLl9zdWJzY3JpcHRpb25zW2luc3RhbmNlSWRdO1xuICAgICAgaWYgKHN1YnNjcmlwdGlvbi5mdXR1cmUpIHtcbiAgICAgICAgc3Vic2NyaXB0aW9uLmZ1dHVyZS5yZXNvbHZlKGZhbHNlKTtcbiAgICAgICAgY2xlYXJUaW1lb3V0KHN1YnNjcmlwdGlvbi53YWl0VGFzayk7XG4gICAgICB9XG4gICAgICBpZiAoc3Vic2NyaXB0aW9uLnRhc2spIHtcbiAgICAgICAgc3Vic2NyaXB0aW9uLnRhc2sucmVzb2x2ZShmYWxzZSk7XG4gICAgICB9XG4gICAgICBzdWJzY3JpcHRpb24uc2hvdWxkUmV0cnkgPSBmYWxzZTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogQ2FuY2VscyBhY3RpdmUgc3Vic2NyaXB0aW9uIHRhc2tzIGZvciBhbiBhY2NvdW50XG4gICAqIEBwYXJhbSB7U3RyaW5nfSBhY2NvdW50SWQgYWNjb3VudCBpZCB0byBjYW5jZWwgc3Vic2NyaXB0aW9uIHRhc2tzIGZvclxuICAgKi9cbiAgY2FuY2VsQWNjb3VudChhY2NvdW50SWQpIHtcbiAgICBmb3IgKGxldCBpbnN0YW5jZUlkIG9mIE9iamVjdC5rZXlzKHRoaXMuX3N1YnNjcmlwdGlvbnMpLmZpbHRlcihrZXkgPT4ga2V5LnN0YXJ0c1dpdGgoYWNjb3VudElkKSkpIHtcbiAgICAgIHRoaXMuY2FuY2VsU3Vic2NyaWJlKGluc3RhbmNlSWQpO1xuICAgIH1cbiAgICBPYmplY3Qua2V5cyh0aGlzLl9hd2FpdGluZ1Jlc3Vic2NyaWJlKS5mb3JFYWNoKGluc3RhbmNlTnVtYmVyID0+IFxuICAgICAgZGVsZXRlIHRoaXMuX2F3YWl0aW5nUmVzdWJzY3JpYmVbaW5zdGFuY2VOdW1iZXJdW2FjY291bnRJZF0pO1xuICAgIGRlbGV0ZSB0aGlzLl90aW1lb3V0RXJyb3JDb3VudGVyW2FjY291bnRJZF07XG4gIH1cblxuICAvKipcbiAgICogSW52b2tlZCBvbiBhY2NvdW50IHRpbWVvdXQuXG4gICAqIEBwYXJhbSB7U3RyaW5nfSBhY2NvdW50SWQgaWQgb2YgdGhlIE1ldGFUcmFkZXIgYWNjb3VudFxuICAgKiBAcGFyYW0ge051bWJlcn0gaW5zdGFuY2VOdW1iZXIgaW5zdGFuY2UgaW5kZXggbnVtYmVyXG4gICAqL1xuICBvblRpbWVvdXQoYWNjb3VudElkLCBpbnN0YW5jZU51bWJlcikge1xuICAgIGNvbnN0IHJlZ2lvbiA9IHRoaXMuX3dlYnNvY2tldENsaWVudC5nZXRBY2NvdW50UmVnaW9uKGFjY291bnRJZCk7XG4gICAgaWYgKHRoaXMuX3dlYnNvY2tldENsaWVudC5zb2NrZXRJbnN0YW5jZXNCeUFjY291bnRzW2luc3RhbmNlTnVtYmVyXVthY2NvdW50SWRdICE9PSB1bmRlZmluZWQgJiYgXG4gICAgICB0aGlzLl93ZWJzb2NrZXRDbGllbnQuY29ubmVjdGVkKGluc3RhbmNlTnVtYmVyLCBcbiAgICAgICAgdGhpcy5fd2Vic29ja2V0Q2xpZW50LnNvY2tldEluc3RhbmNlc0J5QWNjb3VudHNbaW5zdGFuY2VOdW1iZXJdW2FjY291bnRJZF0sIHJlZ2lvbikpIHtcbiAgICAgIHRoaXMuX2xvZ2dlci5kZWJ1ZyhgJHthY2NvdW50SWR9OiR7aW5zdGFuY2VOdW1iZXJ9OiBzY2hlZHVsaW5nIHN1YnNjcmliZSBiZWNhdXNlIG9mIGFjY291bnQgdGltZW91dGApO1xuICAgICAgdGhpcy5zY2hlZHVsZVN1YnNjcmliZShhY2NvdW50SWQsIGluc3RhbmNlTnVtYmVyLCB0cnVlKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogSW52b2tlZCB3aGVuIGNvbm5lY3Rpb24gdG8gTWV0YVRyYWRlciB0ZXJtaW5hbCB0ZXJtaW5hdGVkXG4gICAqIEBwYXJhbSB7U3RyaW5nfSBhY2NvdW50SWQgaWQgb2YgdGhlIE1ldGFUcmFkZXIgYWNjb3VudFxuICAgKiBAcGFyYW0ge051bWJlcn0gaW5zdGFuY2VOdW1iZXIgaW5zdGFuY2UgaW5kZXggbnVtYmVyXG4gICAqL1xuICBhc3luYyBvbkRpc2Nvbm5lY3RlZChhY2NvdW50SWQsIGluc3RhbmNlTnVtYmVyKSB7XG4gICAgYXdhaXQgbmV3IFByb21pc2UocmVzID0+IHNldFRpbWVvdXQocmVzLCBNYXRoLm1heChNYXRoLnJhbmRvbSgpICogNSwgMSkgKiAxMDAwKSk7XG4gICAgaWYgKHRoaXMuX3dlYnNvY2tldENsaWVudC5zb2NrZXRJbnN0YW5jZXNCeUFjY291bnRzW2luc3RhbmNlTnVtYmVyXVthY2NvdW50SWRdICE9PSB1bmRlZmluZWQpIHtcbiAgICAgIHRoaXMuX2xvZ2dlci5kZWJ1ZyhgJHthY2NvdW50SWR9OiR7aW5zdGFuY2VOdW1iZXJ9OiBzY2hlZHVsaW5nIHN1YnNjcmliZSBiZWNhdXNlIGFjY291bnQgZGlzY29ubmVjdGVkYCk7XG4gICAgICB0aGlzLnNjaGVkdWxlU3Vic2NyaWJlKGFjY291bnRJZCwgaW5zdGFuY2VOdW1iZXIsIHRydWUpO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBJbnZva2VkIHdoZW4gY29ubmVjdGlvbiB0byBNZXRhQXBpIHdlYnNvY2tldCBBUEkgcmVzdG9yZWQgYWZ0ZXIgYSBkaXNjb25uZWN0LlxuICAgKiBAcGFyYW0ge051bWJlcn0gaW5zdGFuY2VOdW1iZXIgaW5zdGFuY2UgaW5kZXggbnVtYmVyXG4gICAqIEBwYXJhbSB7TnVtYmVyfSBzb2NrZXRJbnN0YW5jZUluZGV4IHNvY2tldCBpbnN0YW5jZSBpbmRleFxuICAgKiBAcGFyYW0ge1N0cmluZ1tdfSByZWNvbm5lY3RBY2NvdW50SWRzIGFjY291bnQgaWRzIHRvIHJlY29ubmVjdFxuICAgKi9cbiAgb25SZWNvbm5lY3RlZChpbnN0YW5jZU51bWJlciwgc29ja2V0SW5zdGFuY2VJbmRleCwgcmVjb25uZWN0QWNjb3VudElkcykge1xuICAgIGlmICghdGhpcy5fYXdhaXRpbmdSZXN1YnNjcmliZVtpbnN0YW5jZU51bWJlcl0pIHtcbiAgICAgIHRoaXMuX2F3YWl0aW5nUmVzdWJzY3JpYmVbaW5zdGFuY2VOdW1iZXJdID0ge307XG4gICAgfVxuICAgIHRyeSB7XG4gICAgICBjb25zdCBzb2NrZXRJbnN0YW5jZXNCeUFjY291bnRzID0gdGhpcy5fd2Vic29ja2V0Q2xpZW50LnNvY2tldEluc3RhbmNlc0J5QWNjb3VudHNbaW5zdGFuY2VOdW1iZXJdO1xuICAgICAgZm9yKGxldCBpbnN0YW5jZUlkIG9mIE9iamVjdC5rZXlzKHRoaXMuX3N1YnNjcmlwdGlvbnMpKXtcbiAgICAgICAgY29uc3QgYWNjb3VudElkID0gaW5zdGFuY2VJZC5zcGxpdCgnOicpWzBdO1xuICAgICAgICBpZiAoc29ja2V0SW5zdGFuY2VzQnlBY2NvdW50c1thY2NvdW50SWRdID09PSBzb2NrZXRJbnN0YW5jZUluZGV4KSB7XG4gICAgICAgICAgdGhpcy5jYW5jZWxTdWJzY3JpYmUoaW5zdGFuY2VJZCk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIHJlY29ubmVjdEFjY291bnRJZHMuZm9yRWFjaChhc3luYyBhY2NvdW50SWQgPT4ge1xuICAgICAgICB0cnkge1xuICAgICAgICAgIGlmICghdGhpcy5fYXdhaXRpbmdSZXN1YnNjcmliZVtpbnN0YW5jZU51bWJlcl1bYWNjb3VudElkXSkge1xuICAgICAgICAgICAgdGhpcy5fYXdhaXRpbmdSZXN1YnNjcmliZVtpbnN0YW5jZU51bWJlcl1bYWNjb3VudElkXSA9IHRydWU7XG4gICAgICAgICAgICB3aGlsZSAodGhpcy5pc0FjY291bnRTdWJzY3JpYmluZyhhY2NvdW50SWQsIGluc3RhbmNlTnVtYmVyKSkge1xuICAgICAgICAgICAgICBhd2FpdCBuZXcgUHJvbWlzZShyZXMgPT4gc2V0VGltZW91dChyZXMsIDEwMDApKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGF3YWl0IG5ldyBQcm9taXNlKHJlcyA9PiBzZXRUaW1lb3V0KHJlcywgTWF0aC5yYW5kb20oKSAqIDUwMDApKTtcbiAgICAgICAgICAgIGlmICh0aGlzLl9hd2FpdGluZ1Jlc3Vic2NyaWJlW2luc3RhbmNlTnVtYmVyXVthY2NvdW50SWRdKSB7XG4gICAgICAgICAgICAgIGRlbGV0ZSB0aGlzLl9hd2FpdGluZ1Jlc3Vic2NyaWJlW2luc3RhbmNlTnVtYmVyXVthY2NvdW50SWRdO1xuICAgICAgICAgICAgICB0aGlzLl9sb2dnZXIuZGVidWcoYCR7YWNjb3VudElkfToke2luc3RhbmNlTnVtYmVyfTogc2NoZWR1bGluZyBzdWJzY3JpYmUgYmVjYXVzZSBhY2NvdW50IHJlY29ubmVjdGVkYCk7XG4gICAgICAgICAgICAgIHRoaXMuc2NoZWR1bGVTdWJzY3JpYmUoYWNjb3VudElkLCBpbnN0YW5jZU51bWJlcik7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuICAgICAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgICAgICB0aGlzLl9sb2dnZXIuZXJyb3IoYCR7YWNjb3VudElkfTogQWNjb3VudCByZXN1YnNjcmliZSB0YXNrIGZhaWxlZGAsIGVycik7XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgdGhpcy5fbG9nZ2VyLmVycm9yKCdGYWlsZWQgdG8gcHJvY2VzcyBzdWJzY3JpYmUgbWFuYWdlciByZWNvbm5lY3RlZCBldmVudCcsIGVycik7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIFNjaGVkdWxlcyBhIHRhc2sgdG8gcmVmcmVzaCB0aGUgYWNjb3VudCBkYXRhXG4gICAqIEBwYXJhbSB7c3RyaW5nfSBhY2NvdW50SWQgYWNjb3VudCBpZFxuICAgKi9cbiAgcmVmcmVzaEFjY291bnQoYWNjb3VudElkKSB7XG4gICAgY29uc3QgbWFpbkFjY291bnRJZCA9IHRoaXMuX3dlYnNvY2tldENsaWVudC5hY2NvdW50c0J5UmVwbGljYUlkW2FjY291bnRJZF07XG4gICAgaWYgKG1haW5BY2NvdW50SWQpIHtcbiAgICAgIGNvbnN0IHJlZ2lzdHJ5ID0gdGhpcy5fbWV0YUFwaS5fY29ubmVjdGlvblJlZ2lzdHJ5O1xuICAgICAgY29uc3QgcnBjQ29ubmVjdGlvbiA9IHJlZ2lzdHJ5LnJwY0Nvbm5lY3Rpb25zW21haW5BY2NvdW50SWRdO1xuICAgICAgY29uc3QgcmVnaW9uID0gdGhpcy5fd2Vic29ja2V0Q2xpZW50LmdldEFjY291bnRSZWdpb24oYWNjb3VudElkKTtcbiAgICAgIGlmIChyZWdpb24pIHtcbiAgICAgICAgaWYgKHJwY0Nvbm5lY3Rpb24pIHtcbiAgICAgICAgICBycGNDb25uZWN0aW9uLnNjaGVkdWxlUmVmcmVzaChyZWdpb24pO1xuICAgICAgICB9XG4gICAgICAgIGNvbnN0IHN0cmVhbWluZ0Nvbm5lY3Rpb24gPSByZWdpc3RyeS5zdHJlYW1pbmdDb25uZWN0aW9uc1ttYWluQWNjb3VudElkXTtcbiAgICAgICAgaWYgKHN0cmVhbWluZ0Nvbm5lY3Rpb24pIHtcbiAgICAgICAgICBzdHJlYW1pbmdDb25uZWN0aW9uLnNjaGVkdWxlUmVmcmVzaChyZWdpb24pO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICB9XG59Il0sIm5hbWVzIjpbIlN1YnNjcmlwdGlvbk1hbmFnZXIiLCJpc0FjY291bnRTdWJzY3JpYmluZyIsImFjY291bnRJZCIsImluc3RhbmNlTnVtYmVyIiwidW5kZWZpbmVkIiwiT2JqZWN0Iiwia2V5cyIsIl9zdWJzY3JpcHRpb25zIiwiaW5jbHVkZXMiLCJrZXkiLCJzdGFydHNXaXRoIiwiaXNEaXNjb25uZWN0ZWRSZXRyeU1vZGUiLCJpbnN0YW5jZUlkIiwiaXNTdWJzY3JpcHRpb25BY3RpdmUiLCJfc3Vic2NyaXB0aW9uU3RhdGUiLCJzdWJzY3JpYmUiLCJfd2Vic29ja2V0Q2xpZW50IiwicnBjUmVxdWVzdCIsInR5cGUiLCJpbnN0YW5jZUluZGV4Iiwic2NoZWR1bGVTdWJzY3JpYmUiLCJjbGllbnQiLCJzaG91bGRSZXRyeSIsInRhc2siLCJ3YWl0VGFzayIsImZ1dHVyZSIsInN1YnNjcmliZVJldHJ5SW50ZXJ2YWxJblNlY29uZHMiLCJyZXNvbHZlU3Vic2NyaWJlIiwicHJvbWlzZSIsIlByb21pc2UiLCJyZXMiLCJyZXNvbHZlIiwic3Vic2NyaWJlVGFzayIsImVyciIsIm5hbWUiLCJzb2NrZXRJbnN0YW5jZUluZGV4Iiwic29ja2V0SW5zdGFuY2VzQnlBY2NvdW50cyIsIm1ldGFkYXRhIiwiX2xvZ2dlciIsImVycm9yIiwibG9ja1NvY2tldEluc3RhbmNlIiwiZ2V0QWNjb3VudFJlZ2lvbiIsInJldHJ5VGltZSIsIkRhdGUiLCJyZWNvbW1lbmRlZFJldHJ5VGltZSIsImdldFRpbWUiLCJub3ciLCJzZXRUaW1lb3V0IiwicmVmcmVzaEFjY291bnQiLCJtYWluQWNjb3VudElkIiwiYWNjb3VudHNCeVJlcGxpY2FJZCIsInJlZ2lvbiIsImNvbm5lY3RlZEluc3RhbmNlcyIsIl9sYXRlbmN5U2VydmljZSIsImdldEFjdGl2ZUFjY291bnRJbnN0YW5jZXMiLCJzb21lIiwiaW5zdGFuY2UiLCJfdGltZW91dEVycm9yQ291bnRlciIsInJldHJ5SW50ZXJ2YWwiLCJNYXRoIiwibWluIiwic3Vic2NyaWJlUHJvbWlzZSIsInJlc3VsdCIsInVuc3Vic2NyaWJlIiwiY2FuY2VsQWNjb3VudCIsImNhbmNlbFN1YnNjcmliZSIsInN1YnNjcmlwdGlvbiIsImNsZWFyVGltZW91dCIsImZpbHRlciIsIl9hd2FpdGluZ1Jlc3Vic2NyaWJlIiwiZm9yRWFjaCIsIm9uVGltZW91dCIsImNvbm5lY3RlZCIsImRlYnVnIiwib25EaXNjb25uZWN0ZWQiLCJtYXgiLCJyYW5kb20iLCJvblJlY29ubmVjdGVkIiwicmVjb25uZWN0QWNjb3VudElkcyIsInNwbGl0IiwicmVnaXN0cnkiLCJfbWV0YUFwaSIsIl9jb25uZWN0aW9uUmVnaXN0cnkiLCJycGNDb25uZWN0aW9uIiwicnBjQ29ubmVjdGlvbnMiLCJzY2hlZHVsZVJlZnJlc2giLCJzdHJlYW1pbmdDb25uZWN0aW9uIiwic3RyZWFtaW5nQ29ubmVjdGlvbnMiLCJjb25zdHJ1Y3RvciIsIndlYnNvY2tldENsaWVudCIsIm1ldGFBcGkiLCJMb2dnZXJNYW5hZ2VyIiwiZ2V0TG9nZ2VyIiwiX3JlY2VudGx5RGVsZXRlZEFjY291bnRzIl0sIm1hcHBpbmdzIjoiQUFBQTs7Ozs7OztlQU9xQkE7OzsrREFMSzs7Ozs7O0FBS1gsSUFBQSxBQUFNQSxzQkFBTixNQUFNQTtJQWtCbkI7Ozs7O0dBS0MsR0FDREMscUJBQXFCQyxTQUFTLEVBQUVDLGNBQWMsRUFBRTtRQUM5QyxJQUFJQSxtQkFBbUJDLFdBQVc7WUFDaEMsT0FBT0MsT0FBT0MsSUFBSSxDQUFDLElBQUksQ0FBQ0MsY0FBYyxFQUFFQyxRQUFRLENBQUNOLFlBQVksTUFBTUM7UUFDckUsT0FBTztZQUNMLEtBQUssSUFBSU0sT0FBT0osT0FBT0MsSUFBSSxDQUFDLElBQUksQ0FBQ0MsY0FBYyxFQUFHO2dCQUNoRCxJQUFJRSxJQUFJQyxVQUFVLENBQUNSLFlBQVk7b0JBQzdCLE9BQU87Z0JBQ1Q7WUFDRjtZQUNBLE9BQU87UUFDVDtJQUNGO0lBRUE7Ozs7O0dBS0MsR0FDRFMsd0JBQXdCVCxTQUFTLEVBQUVDLGNBQWMsRUFBRTtRQUNqRCxJQUFJUyxhQUFhVixZQUFZLE1BQU9DLENBQUFBLGtCQUFrQixDQUFBO1FBQ3RELE9BQU8sSUFBSSxDQUFDSSxjQUFjLENBQUNLLFdBQVcsR0FBRyxJQUFJLENBQUNMLGNBQWMsQ0FBQ0ssV0FBVyxDQUFDRCx1QkFBdUIsR0FBRztJQUNyRztJQUVBOzs7O0dBSUMsR0FDREUscUJBQXFCWCxTQUFTLEVBQUU7UUFDOUIsT0FBTyxDQUFDLENBQUMsSUFBSSxDQUFDWSxrQkFBa0IsQ0FBQ1osVUFBVTtJQUM3QztJQUVBOzs7OztHQUtDLEdBQ0RhLFVBQVViLFNBQVMsRUFBRUMsY0FBYyxFQUFFO1FBQ25DLElBQUksQ0FBQ1csa0JBQWtCLENBQUNaLFVB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